#!/bin/bash

set -e

__FILE__="${0}"
export AZK_ROOT_PATH=`cd \`dirname $(readlink ${__FILE__} || echo ${__FILE__} )\`/..; pwd`
export DEFAULT_DATA_PATH=${DEFAULT_DATA_PATH:-$AZK_ROOT_PATH/data}

export PATH=/usr/bin:/bin:/usr/sbin
export PATH=$AZK_ROOT_PATH/bin:$PATH
export PATH=$AZK_ROOT_PATH/lib/libexec:$PATH

# Configure NVM and VM
export NVM_DIR=$DEFAULT_DATA_PATH/nvm
export VM_DISK_PATH=$DEFAULT_DATA_PATH/vm

# local
node_version=v0.11.11
libexec_deps=$AZK_ROOT_PATH/lib/libexec
git_raw=https://raw2.github.com
nvm_url=$git_raw/creationix/nvm/master/nvm.sh
data_url=http://goo.gl/OKXJO7
boot_url=http://goo.gl/DAnaCj

log() {
  e="echo"
  if [ -n "$2" -a "$1" == "-n" ]; then
    shift
    e="echo -n"
  fi
  $e >&2 "[`date +"%Y-%m-%d %H:%M:%S"`] ${*}"
}

# Check if all required commands exist
cmd_exists() {
  while [ -n "$1" ]; do
    command -v $1 >/dev/null 2>&1 || \
      { log "command '$1' is required but not installed.  Aborting."; notOK=1; }
    shift
  done
  if [ -n "$notOK" ]; then
    exit 1
  fi
}
cmd_exists git nc curl grep head tr

# Roles
check_nvm() {
  [ -f $libexec_deps/nvm.sh ]
}

check_node() {
  . $libexec_deps/nvm.sh
  nvm use $node_version &>/dev/null
}

check_npm() {
  [ -d $AZK_ROOT_PATH/node_modules ]
}

check_boot_disk() {
  [ -f $VM_DISK_PATH/debian2docker.iso ]
}

check_data_disk() {
  [ -f $VM_DISK_PATH/azk-agent.vmdk.bz ]
}

# Check for depedencies
# TODO: format logs as standard
check_depedencies() {
  msg() {
    log "azk:error dependencies '$1' not installed. Run 'azk configure'"
    exit 1
  }

  check_nvm  || msg nvm
  check_node || msg node
  check_npm  || msg 'node dependencies'
  check_data_disk || msg 'blank data disk'
  check_boot_disk || msg 'iso vm boot'
}

check_install() {
  log -n "$2: "
  if `$1` ; then
    echo "ok" >&2
  else
    echo "fail" >&2
    return 1
  fi
}

configure() {
  ok()   { echo "ok" >&2; }
  fail() { echo "fail" >&2; }

  check_install "check_nvm" "Check nvm" || {
    log "Install nvm..."
    curl $nvm_url -o $libexec_deps/nvm.sh
  }

  # Load nvm
  mkdir -p $NVM_DIR
  . $libexec_deps/nvm.sh

  check_install "check_node" "Check node" || {
    log "Install node..."
    nvm install $node_version
  }

  nvm use $node_version &>/dev/null
  check_install "check_npm" "Check azk node dependencies" || {
    log "Install node depedencies..."
    cd $AZK_ROOT_PATH
    npm install
  }

  # Vm disks
  mkdir -p $VM_DISK_PATH

  check_install "check_boot_disk" "Check iso to boot vm" || {
    log "Download iso"
    curl -L $boot_url -o $VM_DISK_PATH/debian2docker.iso
  }

  check_install "check_data_disk" "Check blank data disk" || {
    log "Download disk"
    curl -L $data_url -o $VM_DISK_PATH/azk-agent.vmdk.bz
  }
}

azk_main() {
  case "$1" in
    configure)
      configure
      ;;
    nvm)
      check_depedencies
      shift; "${@}"
      ;;
    *)
      check_depedencies
      node --harmony $AZK_ROOT_PATH/bin/azk.js "${@}"
  esac
}

# run main function
azk_main "${@}"
