#!/bin/sh

set -e

__FILE__=${BASH_SOURCE:-$0}
export AZK_ROOT_PATH=`cd \`dirname $(readlink ${__FILE__} || echo ${__FILE__} )\`/..; pwd`
export AZK_DATA_PATH=${AZK_DATA_PATH:-$AZK_ROOT_PATH/data}

# Npm folder
export AZK_LIB_PATH=${AZK_LIB_PATH:-$AZK_ROOT_PATH/lib};
export AZK_NPM_PATH=${AZK_NPM_PATH:-$AZK_LIB_PATH/node_modules};
export NVM_DIR=$AZK_LIB_PATH/nvm
node_version=`cat $AZK_ROOT_PATH/.nvmrc`

# Node load paths
export NODE_PATH=$NVM_DIR/$node_version/node_modules
export NODE_PATH=$AZK_ROOT_PATH:$NODE_PATH
export NODE_PATH=$AZK_NPM_PATH:$NODE_PATH
export NODE_PATH=$AZK_LIB_PATH:$NODE_PATH

# Extra path
export PATH=$NVM_DIR/$node_version/bin:$PATH
export PATH=$AZK_NPM_PATH/.bin:$PATH

# No use DOCKER_HOST
unset DOCKER_HOST

make_data_folders() {
  data_folders=(
    "$NVM_DIR"
    "$AZK_DATA_PATH"
    "$AZK_DATA_PATH/run"
    "$AZK_DATA_PATH/vm"
    "$AZK_DATA_PATH/logs"
  )

  for dir in "${data_folders[@]}"; do
    [ -d "$dir" ] || mkdir -p $dir
  done
}

azk_load_nvm() {
  if ! node --version &>/dev/null ; then
    echo "node not installed";
    echo "run: make bootstrap";
    exit 1;
  fi
}

azk_node_run() {
  exec node --harmony $AZK_ROOT_PATH/bin/azk.js "${@}"
}

azk_main() {
  make_data_folders
  case "$1" in
    nvm)
      shift; "${@}"
      ;;
    *)
      azk_load_nvm
      azk_node_run "${@}"
  esac
}

# run main function
azk_main "${@}"

