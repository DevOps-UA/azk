#!/bin/sh

set -e

__FILE__=${BASH_SOURCE:-$0}
export AZK_ROOT_PATH=`cd \`dirname $(readlink ${__FILE__} || echo ${__FILE__} )\`/..; pwd`

# Npm folder
AZK_NPM_PATH=${AZK_NPM_PATH:-$AZK_ROOT_PATH};
export AZK_LIB_PATH=${AZK_LIB_PATH:-$AZK_ROOT_PATH/lib};
export NVM_DIR=$AZK_LIB_PATH/nvm

# Node load paths
export NODE_PATH=$AZK_ROOT_PATH
export NODE_PATH=$AZK_NPM_PATH/node_modules:$NODE_PATH
export NODE_PATH=$AZK_LIB_PATH:$NODE_PATH

# Extra path
export PATH=$AZK_NPM_PATH/node_modules/.bin:$PATH

# Configs
node_version=`cat $AZK_ROOT_PATH/.nvmrc`
nvm_file=$AZK_ROOT_PATH/vendor/bin/nvm.sh

azk_load_nvm() {
  mkdir -p $NVM_DIR
  . $nvm_file
  nvm use $node_version || { echo "node not installed"; }
}

azk_node_run() {
  exec node --harmony $AZK_ROOT_PATH/bin/azk.js "${@}"
}

azk_main() {
  azk_load_nvm &>/dev/null
  case "$1" in
    bootstrap)
      echo "installing node"
      nvm install $node_version
      ;;
    nvm)
      shift; "${@}"
      ;;
    *)
      azk_node_run "${@}"
  esac
}

# run main function
azk_main "${@}"

