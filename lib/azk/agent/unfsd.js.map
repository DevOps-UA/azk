{"version":3,"file":"unfsd.js","sources":["../../../src/agent/unfsd.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/15","@traceur/generated/TemplateParser/8","@traceur/generated/TemplateParser/14","@traceur/generated/TemplateParser/11","@traceur/generated/TemplateParser/12","@traceur/generated/TemplateParser/9","@traceur/generated/TemplateParser/18","@traceur/generated/TemplateParser/13","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"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","sourcesContent":["import { Q, fs, config, log, defer } from 'azk';\nimport { net } from 'azk/utils';\nimport { VM  } from 'azk/agent/vm';\nimport { Tools } from 'azk/agent/tools';\nvar forever = require('forever-monitor');\n\nvar Unfsd = {\n  child: null,\n  port : null,\n  ip   : null,\n\n  start() {\n    return Tools.async_status(\"unsfd\", this, function* (change_status) {\n      if (this.isRunnig()) return;\n\n      var port = this.port = yield net.getPort();\n      var file = this.__checkConfig();\n      var args = [\n        config(\"paths:unfsd\"),\n        \"-s\", \"-d\", \"-p\", \"-t\",\n        \"-n\", port,\n        \"-m\", port,\n        \"-e\", file\n      ]\n\n      return defer((resolve, reject) => {\n        change_status(\"starting\");\n        this.child = forever.start(args, {\n          max : 5,\n          silent : true,\n          pidFile: config(\"paths:unfsd_pid\")\n        });\n\n        this.child.on('start', () => {\n          change_status(\"started\", { port: port, file: file });\n          resolve();\n        });\n      });\n    });\n  },\n\n  stop() {\n    return Tools.defer_status(\"unsfd\", (resolve, _reject, change_status) => {\n      log.debug(\"call to stop unsfd\");\n      if (this.child) {\n        this.child.on('stop', () => {\n          change_status(\"stoped\");\n          resolve();\n        });\n        change_status(\"stopping\");\n        this.child.stop();\n      } else {\n        resolve();\n      }\n    });\n  },\n\n  mount(vm_name) {\n    return Tools.defer_status(\"unsfd\", (_resolve, _reject, change_status) => {\n      var point = config('agent:vm:mount_point');\n      var ip    = net.calculateGatewayIp(config(\"agent:vm:ip\"))\n      var opts  = [\n        `port=${this.port}`,\n        `mountport=${this.port}`,\n        'mountvers=3',\n        'nfsvers=3',\n        'nolock',\n        'tcp',\n      ]\n      var mount = `sudo mount -o ${opts.join(',')} ${ip}:/ ${point}`\n      var check = `mount | grep ${point} &>/dev/null`;\n      var cmd = [\n        `[ -d \"${point}\" ] || { mkdir -p ${point}; }`,\n        \"{ \" + check + \" || \" + mount + \"; }\",\n        \"{ \" + check + \"; }\",\n      ].join(\"; \");\n\n      var stderr = \"\";\n      var progress = (event) => {\n        if (event.type == \"ssh\" && event.context == \"stderr\") {\n          stderr += event.data.toString();\n        }\n        return event;\n      }\n\n      change_status(\"mounting\");\n      return VM.ssh(vm_name, cmd).progress(progress).then((code) => {\n        if (code != 0)\n          throw new Error('not mount share files, error:\\n' + stderr);\n        change_status(\"mounted\");\n      });\n    });\n  },\n\n  isRunnig() {\n    return (this.child && this.child.running);\n  },\n\n  __checkConfig() {\n    var file = config('paths:unfsd_file');\n\n    // set content\n    fs.writeFileSync(file, [\n      \"# All\",\n      \"/ \" + net.calculateNetIp(config(\"agent:vm:ip\")) + \"(rw)\"\n    ].join(\"\\n\"));\n\n    return file;\n  }\n}\n\nexport { Unfsd }\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","return $__placeholder__0(\n            $__placeholder__1,\n            this);","$traceurRuntime.generatorWrap","function($ctx) {\n      while (true) $__placeholder__0\n    }","$ctx.state = ($__placeholder__0) ? $__placeholder__1 : $__placeholder__2;\n        break","return $__placeholder__0","$ctx.sent","$ctx.returnValue = $__placeholder__0","return $ctx.end()","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}