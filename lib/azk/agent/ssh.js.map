{"version":3,"file":"ssh.js","sources":["../../../src/agent/ssh.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/6","@traceur/generated/TemplateParser/7","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"AAAA;ACAI,CAAJ,EAAI,CAAA,YAAY,kBAAoB,CAAC;UCArC,CAAA,OAAO,CFAgD,KAAK,CEAlC;;;;;;;;SAA1B,CAAA,OAAO,CFCa,WAAW,CEDL;AFGtB,CAAJ,EAAI,CAAA,IAAI,EAAG,CAAA,OAAO,CAAC,MAAM,CAAC,CAAC;AACvB,CAAJ,EAAI,CAAA,IAAI,EAAG,CAAA,OAAO,CAAC,MAAM,CAAC,OAAO,CAAC;AAC9B,CAAJ,EAAI,CAAA,WAAW,EAAG,MAAK,CAAC;AGLpB,CAAJ,EAAI,MHOG,SAAM,IAAG,CACF,IAAI,CAAE,CAAA,IAAI,CAAE;AACtB,CAAA,KAAI,KAAK,EAAG,KAAI,CAAC;AACjB,CAAA,KAAI,KAAK,EAAG,KAAI,CAAC;CGVoB,AHWtC,CGXsC;ACAzC,CAAA,AAAC,eAAe,YAAY,CAAC;CJa3B,KAAI,CAAJ,UAAK,GAAG,AAAc;OAAZ,KAAI,6CAAG,MAAK;CACpB,SAAO,CAAA,IAAI,QAAQ,CAAC,IAAI,YAAG,MAAM,CAAE,CAAA,IAAI;AACrC,CAAA,QAAG,MAAM,CAAC,sBAAsB,CAAE,IAAG,CAAC,CAAC;AACvC,CAAA,SAAI,OAAO,CAAC;AAAE,CAAA,WAAI,CAAE,MAAK;AAAE,CAAA,cAAO,CAAE,UAAS;AAAE,CAAA,UAAG,CAAE,IAAG;CAAA,MAAC,CAAC,CAAC;AAE1D,CAAA,WAAM,KAAK,CAAC,GAAG,YAAG,GAAG,CAAE,CAAA,MAAM;CAC3B,WAAI,GAAG;CAAE,eAAO,CAAA,IAAI,OAAO,CAAC,GAAG,CAAC,CAAC;AACjC,CADiC,aAC3B,GAAG,CAAC,MAAM,YAAG,IAAI,CAAE,CAAA,QAAQ,CAAK;AAChC,CAAJ,YAAI,CAAA,OAAO,EAAG,CAAA,QAAQ,EAAG,SAAQ,EAAG,SAAQ,CAAC;AAC7C,CAAA,aAAI,OAAO,CAAC;AAAE,CAAA,eAAI,CAAE,MAAK;AAAE,CAAA,kBAAO,CAAP,QAAO;AAAE,CAAA,eAAI,CAAJ,KAAI;CAAA,UAAE,CAAC,CAAC;SAC7C,EAAC,CAAC;AAEH,CAAA,aAAM,GAAG,CAAC,MAAM,YAAG,IAAI;AACrB,CAAA,YAAG,MAAM,CAAC,yBAAyB,CAAE,KAAI,CAAC,CAAC;AAC3C,CAAA,aAAI,QAAQ,CAAC,IAAI,CAAC,CAAC;AACnB,CAAA,gBAAO,SAAS;kBAAO,CAAA,MAAM,IAAI,EAAE;aAAC,CAAC;WACrC,CAAC;SACH,CAAC;OACH,CAAC;GACJ;CAED,YAAW,CAAX,UAAY,GAAG,CAAE;CACf,SAAO,CAAA,GAAG,EAAE,CAAA,GAAG,QAAQ,CAAC,eAAe,CAAE,OAAM,CAAC,CAAA,CAAG,IAAG,CAAC;GACxD;CAED,QAAO,CAAP,UAAQ,MAAM,CAAE,CAAA,IAAI,AAAc;OAAZ,KAAI,6CAAG,MAAK;CAChC,SAAO,CAAA,IAAI,QAAQ,CAAC,IAAI,YAAG,MAAM,CAAE,CAAA,IAAI;AACrC,CAAA,QAAG,MAAM,CAAC,4BAA4B,CAAE,OAAM,CAAE,KAAI,CAAC,CAAC;AACtD,CAAA,SAAI,OAAO,CAAC;AAAE,CAAA,WAAI,CAAE,MAAK;AAAE,CAAA,cAAO,CAAE,MAAK;AAAE,CAAA,aAAM,CAAN,OAAM;AAAE,CAAA,WAAI,CAAJ,KAAI;CAAA,MAAC,CAAC,CAAC;AAE1D,CAAA,WAAM,KAAK,WAAE,GAAG,CAAE,CAAA,IAAI;CACpB,WAAI,GAAG;CAAE,eAAO,CAAA,IAAI,OAAO,CAAC,GAAG,CAAC,CAAC;AAC7B,CAD6B,UAC7B,CAAA,GAAG,EAAG,IAAI,KAAI,EAAE,CAAC;AACrB,CAAA,UAAG,OAAO,EAAG,KAAI,CAAC;AAElB,CAAA,UAAG,OAAO,CAAC,MAAM,CAAE,KAAI,YAAG,GAAG;CAC3B,aAAI,GAAG;CAAE,iBAAO,CAAA,IAAI,OAAO,CAAC,GAAG,CAAC,CAAC;AACjC,CADiC,aAC7B,QAAQ,CAAC,CAAC,CAAC,CAAC;AAChB,CAAA,gBAAO,SAAS;kBAAO,CAAA,MAAM,IAAI,EAAE;aAAC,CAAC;WACrC,CAAC;SACH,CAAC;OACH,CAAC;GACJ;CAED,QAAO,CAAP,UAAQ,IAAI,CAAE,CAAA,QAAQ;;AAChB,CAAJ,MAAI,CAAA,OAAO;CACT,WAAO,CAAA,KAAK,WAAE,IAAI;AACZ,CAAJ,UAAI,CAAA,MAAM,EAAM,IAAI,KAAI,EAAE,CAAC;AACvB,CAAJ,UAAI,CAAA,SAAS,EAAG,EAAC,CAAC;AACd,CAAJ,UAAI,CAAA,OAAO,EAAK;AACd,CAAA,aAAI,CAAE,UAAS;AACf,CAAA,aAAI,CAAE,UAAS;AACf,CAAA,iBAAQ,CAAE,CAAA,MAAM,CAAC,eAAe,CAAC;AACjC,CAAA,qBAAY,CAAE,YAAW;AACzB,CAAA,iBAAQ,CAAE,CAAA,MAAM,CAAC,mBAAmB,CAAC;CAAA,QACtC,CAAC;AAEF,CAAA,aAAM,GAAG,CAAC,OAAO,aAAQ;AACvB,CAAA,aAAI,OAAO,CAAC,CAAE,IAAI,CAAE,YAAW,CAAE,CAAC,CAAC;AACnC,CAAA,YAAG,MAAM,CAAC,wBAAwB,CAAC,CAAC;AACpC,CAAA,iBAAQ,CAAC,MAAM,CAAE,KAAI,CAAC,CAAC;SACxB,EAAC,CAAC;AAEH,CAAA,aAAM,GAAG,CAAC,KAAK,aAAQ;AAAE,CAAA,aAAI,QAAQ,EAAE,CAAC;SAAE,EAAC,CAAC;AAC5C,CAAA,aAAM,GAAG,CAAC,OAAO,YAAG,GAAG,CAAK;AAAE,CAAA,aAAI,OAAO,CAAC,GAAG,CAAC,CAAC;SAAE,EAAC,CAAC;AAEnD,CAAA,aAAM,QAAQ,CAAC,OAAO,CAAC,CAAC;SACxB,CAAC;MACJ,CAAA;CAGD,OAAI,IAAI,CAAE;CACR,WAAO,CAAA,GAAG,sBAAsB,CAAC,IAAI,KAAK,CAAE,CAAA,IAAI,KAAK,CAAE,GAAE,CAAC,KAAK,YAAO;CACpE,aAAO,CAAA,OAAO,EAAE,CAAC;OAClB,EAAC,CAAC;KACJ,KAAM;CACL,WAAO,CAAA,OAAO,EAAE,CAAC;KAClB;CAAA,EACF;MI3FmF;ACAtF,CAAA,KAAM,QAAQ;CCAd,UAAwB;CAAE,cAAyB;GAAE;ACArD,CAAA,WAAU,CAAE,KAAI;CAAA,AFAkB,CAAC;CL6FnC","sourcesContent":["import { Q, fs, path, config, log, defer, async } from 'azk';\nimport { net } from 'azk/utils';\n\nvar ssh2 = require('ssh2');\nvar scp2 = require('scp2').Client;\nvar ssh_timeout = 10000;\n\nexport class SSH {\n  constructor(host, port) {\n    this.host = host;\n    this.port = port;\n  }\n\n  exec(cmd, wait = false) {\n    return this.connect(wait, (client, done) => {\n      log.debug(\"agent vm ssh cmd: %s\", cmd);\n      done.notify({ type: \"ssh\", context: \"running\", cmd: cmd});\n\n      client.exec(cmd, (err, stream) => {\n        if (err) return done.reject(err);\n        stream.on('data', (data, extended) => {\n          var context = extended ? extended : 'stdout';\n          done.notify({ type: \"ssh\", context, data });\n        });\n\n        stream.on('exit', (code) => {\n          log.debug(\"agent vm ssh result: %s\", code);\n          done.resolve(code);\n          process.nextTick(() => client.end());\n        });\n      });\n    });\n  }\n\n  escapeShell(cmd) {\n    return '\"'+ cmd.replace(/([\"\\s'$`\\\\])/g, '\\\\$1') + '\"';\n  }\n\n  putFile(origin, dest, wait = false) {\n    return this.connect(wait, (client, done) => {\n      log.debug(\"agent vm ssh scp: %s => %s\", origin, dest);\n      done.notify({ type: \"ssh\", context: \"scp\", origin, dest});\n\n      client.sftp((err, sftp) => {\n        if (err) return done.reject(err);\n        var scp = new scp2();\n        scp.__sftp = sftp;\n\n        scp.upload(origin, dest, (err) => {\n          if (err) return done.reject(err);\n          done.resolve(0);\n          process.nextTick(() => client.end());\n        });\n      });\n    });\n  }\n\n  connect(wait, callback) {\n    var execute = () => {\n      return defer((done) => {\n        var client    = new ssh2();\n        var exit_code = 0;\n        var options   = {\n          host: this.host,\n          port: this.port,\n          username: config(\"agent:vm:user\"),\n          readyTimeout: ssh_timeout,\n          password: config(\"agent:vm:password\"),\n        };\n\n        client.on(\"ready\", () => {\n          done.notify({ type: 'connected' });\n          log.debug(\"agent vm ssh connected\");\n          callback(client, done);\n        });\n\n        client.on('end', () => { done.resolve(); });\n        client.on('error', (err) => { done.reject(err); });\n\n        client.connect(options);\n      });\n    }\n\n    // TODO: change timeout and attempts for a logic value\n    if (wait) {\n      return net.waitForwardingService(this.host, this.port, 15).then(() => {\n        return execute();\n      });\n    } else {\n      return execute();\n    }\n  }\n}\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","var $__placeholder__0 = $__placeholder__1","($traceurRuntime.createClass)($__placeholder__0, $__placeholder__1, $__placeholder__2)","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}