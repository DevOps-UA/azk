{"version":3,"file":"server.js","sources":["../../../src/agent/server.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/15","@traceur/generated/TemplateParser/8","@traceur/generated/TemplateParser/14","@traceur/generated/TemplateParser/11","@traceur/generated/TemplateParser/12","@traceur/generated/TemplateParser/10","@traceur/generated/TemplateParser/13","@traceur/generated/TemplateParser/9","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"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","sourcesContent":["import { config, defer, async, t, log } from 'azk';\nimport { VM  }   from 'azk/agent/vm';\nimport { Unfsd } from 'azk/agent/unfsd';\nimport { Balancer } from 'azk/agent/balancer';\nimport { net as net_utils } from 'azk/utils';\nimport { AgentStartError } from 'azk/utils/errors';\n\nvar Server = {\n  server: null,\n\n  // TODO: log start machine steps\n  start() {\n    return async(this, function* () {\n      log.info_t(\"commands.agent.starting\");\n\n      // Virtual machine is required?\n      if (config('agent:requires_vm')) {\n        yield this.installShare();\n        yield this.installVM(true);\n      }\n\n      // Load balancer\n      yield this.installBalancer();\n\n      log.info_t(\"commands.agent.started\");\n    });\n  },\n\n  stop() {\n    return async(this, function* () {\n      yield this.removeBalancer();\n      yield this.stopVM();\n      yield this.removeShare();\n    });\n  },\n\n  installBalancer() {\n    return Balancer.start();\n  },\n\n  removeBalancer() {\n    return Balancer.stop();\n  },\n\n  installShare() {\n    return Unfsd.start();\n  },\n\n  removeShare() {\n    return Unfsd.stop();\n  },\n\n  installVM(start = false, mount = true) {\n    var vm_name = config(\"agent:vm:name\");\n    return async(this, function* (notify) {\n      var installed = yield VM.isInstalled(vm_name);\n      var running   = (installed) ? yield VM.isRunnig(vm_name) : false;\n\n      if (!installed) {\n        var opts = {\n          name: vm_name,\n          ip  : config(\"agent:vm:ip\"),\n          boot: config(\"agent:vm:boot_disk\"),\n          data: config(\"agent:vm:data_disk\"),\n        }\n\n        yield VM.init(opts);\n      }\n\n      if (!running && start) {\n        yield VM.start(vm_name);\n\n        // Wait for vm start\n        var n = (status) => notify({ type: \"status\", context: \"vm\", status });\n        n(\"wait\");\n        var success = yield net_utils.waitService(config(\"agent:vm:ip\"), 22, 10, { context: \"vm\" });\n        if (!success) {\n          throw new AgentStartError(t(\"errors.not_vm_start\"));\n        }\n        n(\"initialized\");\n\n        // Mount share fs\n        if (mount)\n          yield Unfsd.mount(vm_name)\n      };\n    });\n  },\n\n  stopVM(running) {\n    var vm_name = config(\"agent:vm:name\");\n    return async(function* () {\n      running = (running == null) ? (yield VM.isRunnig(vm_name)) : false;\n      if (running) {\n        yield VM.stop(vm_name);\n      }\n    });\n  },\n}\n\nexport { Server };\n\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","return $__placeholder__0(\n            $__placeholder__1,\n            this);","$traceurRuntime.generatorWrap","function($ctx) {\n      while (true) $__placeholder__0\n    }","$ctx.state = ($__placeholder__0) ? $__placeholder__1 : $__placeholder__2;\n        break","return $__placeholder__0","$ctx.maybeThrow()","return $ctx.end()","$ctx.sent","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}