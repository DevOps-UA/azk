{"version":3,"file":"server.js","sources":["../../../src/agent/server.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/12","@traceur/generated/TemplateParser/6","@traceur/generated/TemplateParser/11","@traceur/generated/TemplateParser/8","@traceur/generated/TemplateParser/7","@traceur/generated/TemplateParser/9","@traceur/generated/TemplateParser/10","@traceur/generated/TemplateParser/13","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"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","sourcesContent":["import { config, defer, async, t, log } from 'azk';\nimport { VM  }   from 'azk/agent/vm';\nimport { Unfsd } from 'azk/agent/unfsd';\nimport { Balancer } from 'azk/agent/balancer';\nimport { net as net_utils } from 'azk/utils';\nimport { AgentStartError } from 'azk/utils/errors';\nimport { Api } from 'azk/agent/api';\n\nvar Server = {\n  server: null,\n\n  // TODO: log start machine steps\n  start() {\n    return async(this, function* () {\n      log.info_t(\"commands.agent.starting\");\n\n      // Start api\n      yield Api.start();\n\n      // Virtual machine is required?\n      if (config('agent:requires_vm')) {\n        yield this.installShare();\n        yield this.installVM(true);\n        yield this.mountShare();\n      }\n\n      // Load balancer\n      yield this.installBalancer();\n\n      log.info_t(\"commands.agent.started\");\n    });\n  },\n\n  stop() {\n    return async(this, function* () {\n      yield Api.stop();\n      yield this.removeBalancer();\n      if (config('agent:requires_vm')) {\n        yield this.stopVM();\n        yield this.removeShare();\n      }\n    });\n  },\n\n  installBalancer() {\n    return Balancer.start();\n  },\n\n  removeBalancer() {\n    return Balancer.stop();\n  },\n\n  installShare() {\n    return Unfsd.start();\n  },\n\n  removeShare() {\n    return Unfsd.stop();\n  },\n\n  mountShare() {\n    return Unfsd.mount(config(\"agent:vm:name\"));\n  },\n\n  installVM(start = false) {\n    var vm_name = config(\"agent:vm:name\");\n    return async(this, function* (notify) {\n      var installed = yield VM.isInstalled(vm_name);\n      var running   = (installed) ? yield VM.isRunnig(vm_name) : false;\n\n      if (!installed) {\n        var opts = {\n          name: vm_name,\n          ip  : config(\"agent:vm:ip\"),\n          boot: config(\"agent:vm:boot_disk\"),\n          data: config(\"agent:vm:data_disk\"),\n        }\n\n        yield VM.init(opts);\n      }\n\n      if (!running && start) {\n        yield VM.start(vm_name);\n\n        // Wait for vm start\n        var n = (status) => notify({ type: \"status\", context: \"vm\", status });\n        n(\"wait\");\n        var address = `tcp://${config(\"agent:vm:ip\")}:22`;\n        var success = yield net_utils.waitService(address, 10, { context: \"vm\" });\n        if (!success) {\n          throw new AgentStartError(t(\"errors.not_vm_start\"));\n        }\n        n(\"initialized\");\n\n        // Upload key\n        n(\"upkey\");\n        var key = config('agent:vm:ssh_key') + '.pub';\n        var authoried = config('agent:vm:authorized_key');\n        yield VM.copyFile(vm_name, key, authoried);\n      };\n    });\n  },\n\n  stopVM(running) {\n    var vm_name = config(\"agent:vm:name\");\n    return async(function* () {\n      running = (running == null) ? (yield VM.isRunnig(vm_name)) : false;\n      if (running) {\n        yield VM.stop(vm_name);\n      }\n    });\n  },\n}\n\nexport { Server };\n\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","return $__placeholder__0(\n            $__placeholder__1,\n            this);","$traceurRuntime.generatorWrap","function($ctx) {\n      while (true) $__placeholder__0\n    }","return $__placeholder__0","$ctx.maybeThrow()","$ctx.state = ($__placeholder__0) ? $__placeholder__1 : $__placeholder__2;\n        break","return $ctx.end()","$ctx.sent","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}