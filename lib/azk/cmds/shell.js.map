{"version":3,"file":"shell.js","sources":["../../../src/cmds/shell.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","src/cmds/shell.js","@traceur/generated/TemplateParser/8","@traceur/generated/TemplateParser/7","@traceur/generated/TemplateParser/10","@traceur/generated/TemplateParser/9","@traceur/generated/TemplateParser/19","@traceur/generated/TemplateParser/12","@traceur/generated/TemplateParser/18","@traceur/generated/TemplateParser/11","@traceur/generated/TemplateParser/15","@traceur/generated/TemplateParser/13","@traceur/generated/TemplateParser/14","@traceur/generated/TemplateParser/16","@traceur/generated/TemplateParser/17","@traceur/generated/TemplateParser/3","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2","@traceur/generated/TemplateParser/5"],"names":[],"mappings":"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","sourcesContent":["module.exports = function() {\n            $__placeholder__0\n          }.call($__placeholder__1);","var __moduleName = $__placeholder__0;","require($__placeholder__0)","import { _, path, config, t, async, defer, dynamic } from 'azk';\nimport { Command, Helpers } from 'azk/cli/command';\n\ndynamic(this, {\n  Manifest() {\n    return require('azk/manifest').Manifest;\n  },\n\n  docker() {\n    return require('azk/docker').default;\n  }\n});\n\nclass Cmd extends Command {\n  action(opts, extras) {\n    var progress = Helpers.newPullProgress(this);\n\n    return async(this, function* () {\n      var cmd = [opts.cmd, ...opts.__leftover];\n      var dir = this.cwd;\n      var env = {};\n\n      yield Helpers.requireAgent();\n\n      if (opts.image) {\n        // Arbitrary image\n        var manifest = Manifest.makeFake(dir, opts.image);\n        var system   = manifest.systemDefault;\n      } else {\n        var manifest = new Manifest(dir, true);\n        var system   = manifest.systemDefault;\n        if (opts.system) system = manifest.system(opts.system, true);\n      }\n\n      var tty_default = opts.t || !_.isString(opts.command)\n      var tty = (opts.T) ? (opts.t || false) : tty_default;\n\n      var stdin = this.stdin();\n      stdin.custom_pipe = () => { };\n\n      var options  = {\n        interactive: tty,\n        pull   : this.stdout(),\n        stdout : this.stdout(),\n        stderr : this.stderr(),\n        stdin  : stdin,\n        workdir: opts.cwd || null,\n      }\n\n      // Support extra envs, ports and mount volumes\n      options.envs   = this._parse_option(opts.env  , /.+=.+/, '=', 'invalid_env');\n      options.mounts = this._parse_option(opts.mount, /.+:.+:?.*/, ':', 'invalid_mount', (opts) => {\n        return { type: (opts[2] ? opts[1] : 'path'), value: (opts[2] ? opts[2] : opts[1]) };\n      });\n\n      var cmd = [opts.shell || system.shell];\n      if (opts.command) {\n        cmd.push(\"-c\");\n        cmd.push(opts.command);\n      }\n\n      // Remove container before run\n      options.remove = opts.remove;\n\n      var result = defer((resolver, reject) => {\n        var escape = (key, container) => {\n          if (key === \".\") {\n            process.nextTick(() => {\n              docker.getContainer(container).stop({ t: 5000 }).fail(reject);\n            });\n            return true;\n          }\n          return false;\n        };\n\n        system.runShell(cmd, options).\n          progress(Helpers.escapeCapture(escape)).\n          then(resolver, reject);\n      });\n\n      result = yield result.fail((error) => {\n        return this.parseError(error);\n      });\n\n      return result.code;\n    }).progress(progress);\n  }\n\n  parseError(error) {\n    if (error.statusCode) {\n      if (error.statusCode === 404 && error.reason === \"no such container\") {\n        this.fail(\"commands.shell.ended.removed\");\n        return { code: 127 }\n      }\n    } else if (error.code === 'ECONNRESET') {\n      this.fail(\"commands.shell.ended.docker_end\");\n      return { code: 127 }\n    } else if (error.code === 'ECONNREFUSED') {\n      this.fail(\"commands.shell.ended.docker_notfound\");\n      return { code: 127 }\n    }\n    throw error;\n  }\n\n  _parse_option(option, regex, split, fail, format = null) {\n    var result = {};\n    for(var j = 0; j < option.length; j++) {\n      var opt = option[j];\n      if (opt.match(regex)) {\n        opt = opt.split(split);\n        result[opt[0]] = format ? format(opt) : opt[1];\n      } else {\n        this.fail('commands.shell.' + fail, { value: opt });\n        return 1;\n      }\n    }\n    return result;\n  }\n}\n\nexport function init(cli) {\n  (new Cmd('shell [system]', cli))\n    .addOption(['-T'])\n    .addOption(['-t'])\n    .addOption(['--remove', '--rm', '-r'], { default: true })\n    .addOption(['--image', '-i'], { type: String })\n    .addOption(['--command', '-c'], { type: String })\n    .addOption(['--shell'], { type: String })\n    .addOption(['--cwd', '-C'], { type: String })\n    .addOption(['--mount', '-m'], { type: String, acc: true, default: [] })\n    .addOption(['--env', '-e'], { type: String, acc: true, default: [] })\n    .addOption(['--verbose', '-v'])\n    .addExamples(t(\"commands.shell.examples\"))\n}\n","var $__placeholder__0 = $__placeholder__1","$traceurRuntime.defaultSuperCall(this,\n                $__placeholder__0.prototype, arguments)","var $__placeholder__0 = $__placeholder__1","($traceurRuntime.createClass)($__placeholder__0, $__placeholder__1, $__placeholder__2,\n                                       $__placeholder__3)","return $__placeholder__0(\n            $__placeholder__1,\n            this);","$traceurRuntime.generatorWrap","function($ctx) {\n      while (true) $__placeholder__0\n    }","$traceurRuntime.spread($__placeholder__0)","return $__placeholder__0","$ctx.maybeThrow()","$ctx.sent","$ctx.returnValue = $__placeholder__0","return $ctx.end()","return $__placeholder__0","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true","typeof global !== 'undefined' ? global : this"]}