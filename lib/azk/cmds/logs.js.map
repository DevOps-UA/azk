{"version":3,"file":"logs.js","sources":["../../../src/cmds/logs.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","src/cmds/logs.js","@traceur/generated/TemplateParser/8","@traceur/generated/TemplateParser/7","@traceur/generated/TemplateParser/10","@traceur/generated/TemplateParser/9","@traceur/generated/TemplateParser/16","@traceur/generated/TemplateParser/11","@traceur/generated/TemplateParser/15","@traceur/generated/TemplateParser/13","@traceur/generated/TemplateParser/12","@traceur/generated/TemplateParser/14","@traceur/generated/TemplateParser/3","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2","@traceur/generated/TemplateParser/5"],"names":[],"mappings":"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","sourcesContent":["module.exports = function() {\n            $__placeholder__0\n          }.call($__placeholder__1);","var __moduleName = $__placeholder__0;","require($__placeholder__0)","import { log, _, async, defer, config, Q, t, dynamic } from 'azk';\nimport { Command, Helpers } from 'azk/cli/command';\n\ndynamic(this, {\n  Manifest() {\n    return require('azk/manifest').Manifest;\n  },\n\n  docker() {\n    return require('azk/docker').default;\n  }\n});\n\nclass Cmd extends Command {\n  action(opts) {\n    return async(this, function* () {\n      yield Helpers.requireAgent();\n\n      var manifest = new Manifest(this.cwd, true);\n      var systems  = manifest.getSystemsByName(opts.system);\n\n      yield this.logs(manifest, systems, opts);\n    });\n  }\n\n  make_out(output, name) {\n    return {\n      write(buffer) {\n        var data = buffer.toString().match(/^\\[(.*?)\\](.*\\n)$/m);\n        if (data) {\n          output.write(`${data[1].magenta} ${name}:${data[2]}`);\n        } else {\n          output.write(`${name} `);\n          output.write(buffer);\n        }\n      }\n    }\n  }\n\n  connect(system, color, instances, options) {\n    return _.map(instances, (instance) => {\n      var name = `${system.name}${instance.Annotations.azk.seq}`[color];\n      var container = docker.getContainer(instance.Id);\n      var stdout = this.make_out(process.stdout, name);\n      var stderr = this.make_out(process.stderr, name);\n\n      return container.logs(options).then((stream) => {\n        return defer((resolve, reject) => {\n          container.modem.demuxStream(stream, stdout, stderr);\n          stream.on('end', resolve);\n        });\n      });\n    });\n  }\n\n  logs(manifest, systems, opts = {}) {\n    var options = {\n      stdout: true,\n      stderr: true,\n      tail: opts.lines,\n      timestamps: opts.timestamps,\n    };\n\n    if (opts.follow) {\n      options.follow = true;\n    }\n\n    var colors = [\"green\", \"yellow\", \"blue\", \"red\", \"cyan\", \"grey\"];\n    var color  = -1;\n\n    return Q.all(_.map(systems, (system) => {\n      return system.instances({ type: \"daemon\" }).then((instances) => {\n        color++;\n\n        if (opts.instances) {\n          opts.instances = opts.instances.split(',');\n          instances = _.filter(instances, (instance) => {\n            return _.contains(opts.instances, instance.Annotations.azk.seq);\n          });\n        }\n\n        return Q.all(this.connect(system, colors[color % colors.length], instances, options));\n      });\n    }));\n  }\n}\n\nexport { Cmd };\nexport function init(cli) {\n  (new Cmd('logs [system] [instances]', cli))\n    .addOption(['--follow', '--tail', '-f'], { default: false })\n    .addOption(['--lines', '-n'], { type: Number, default: \"all\" })\n    .addOption(['--timestamps'], { default: true });\n}\n\n","var $__placeholder__0 = $__placeholder__1","$traceurRuntime.defaultSuperCall(this,\n                $__placeholder__0.prototype, arguments)","var $__placeholder__0 = $__placeholder__1","($traceurRuntime.createClass)($__placeholder__0, $__placeholder__1, $__placeholder__2,\n                                       $__placeholder__3)","return $__placeholder__0(\n            $__placeholder__1,\n            this);","$traceurRuntime.generatorWrap","function($ctx) {\n      while (true) $__placeholder__0\n    }","return $__placeholder__0","$ctx.maybeThrow()","return $ctx.end()","return $__placeholder__0","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true","typeof global !== 'undefined' ? global : this"]}