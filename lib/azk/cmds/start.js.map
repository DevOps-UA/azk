{"version":3,"file":"start.js","sources":["../../../src/cmds/start.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/7","@traceur/generated/TemplateParser/6","@traceur/generated/TemplateParser/9","@traceur/generated/TemplateParser/8","@traceur/generated/TemplateParser/18","@traceur/generated/TemplateParser/12","@traceur/generated/TemplateParser/17","@traceur/generated/TemplateParser/14","@traceur/generated/TemplateParser/13","@traceur/generated/TemplateParser/15","@traceur/generated/TemplateParser/16","@traceur/generated/TemplateParser/11","@traceur/generated/TemplateParser/19","@traceur/generated/TemplateParser/20","@traceur/generated/TemplateParser/10","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"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","sourcesContent":["import { log, _, async, config, t } from 'azk';\nimport { Command, Helpers } from 'azk/cli/command';\nimport { Manifest } from 'azk/manifest';\nimport { SYSTEMS_CODE_ERROR, NotBeenImplementedError } from 'azk/utils/errors';\n\nclass Cmd extends Command {\n  action(opts) {\n    return async(this, function* () {\n      yield Helpers.requireAgent();\n\n      var manifest = new Manifest(this.cwd, true);\n      var systems  = Helpers.getSystemsByName(manifest, opts.system);\n\n      yield this[`${this.name}`](manifest, systems, opts);\n\n      if (_.contains([\"start\", \"stop\", \"scale\"], this.name)) {\n        this.output(\"\");\n        yield this.status(manifest, systems);\n      }\n    });\n  }\n\n  _scale(system, instances = {}) {\n    var progress = (event) => {\n      var pull_progress = Helpers.newPullProgress(this);\n      if (event.type == \"pull_msg\") {\n        pull_progress(event);\n      } else {\n        var keys = [\"commands\", \"scale\"];\n        switch(event.type) {\n          case \"action\":\n            var data = { image: system.image.name };\n            this.tOutput([...keys, event.action], data);\n            break;\n          case \"scale\":\n            //keys.push((event.from > event.to) ? \"starting\" : \"stopping\");\n            this.tOutput([...keys, \"scale\"], event);\n            //console.log([...keys, \"scale\"], event);\n            break;\n          case \"provision\":\n            this.tOutput([...keys, \"provision\"], event);\n            break;\n          default:\n            log.debug(event);\n        }\n      }\n    }\n\n    return system.scale(instances).progress(progress);\n  }\n\n  start(manifest, systems) {\n    return async(this, function* () {\n      for (var i = 0; i < systems.length; i++) {\n        var system = systems[i];\n        var icc = yield this._scale(system);\n        if (icc == 0) {\n          this.fail('commands.start.already', system);\n          return SYSTEMS_CODE_ERROR;\n        }\n        return 0;\n      }\n    });\n  }\n\n  scale(manifest, systems, opts) {\n    return async(this, function* () {\n      for (var i = 0; i < systems.length; i++) {\n        var system = systems[i];\n        yield this._scale(system, parseInt(opts.to || 1));\n      }\n    })\n  }\n\n  stop(manifest, systems, opts) {\n    return async(this, function* () {\n      for (var i = 0; i < systems.length; i++) {\n        var system = systems[i];\n        var icc    = yield this._scale(system, 0);\n        if (icc == 0) {\n          this.fail('commands.stop.not_running', system);\n          return SYSTEMS_CODE_ERROR;\n        }\n        return 0;\n      }\n    });\n  }\n\n  status(manifest, systems, opts = {}) {\n    var columns = ['System'.blue, 'Status'.green, 'Instances'.yellow, 'Hostname'.green, 'Instances-Ports'.magenta];\n    var table_status = this.table_add('table_status', { head: columns });\n\n    return async(this, function* () {\n      for (var system of systems) {\n        var instances = yield system.instances();\n\n        if (system.balanceable && instances.length > 0) {\n          var hostname = system.url;\n        } else {\n          var hostname = system.hostname;\n        }\n        var ports   = yield this._ports_map(system, instances);\n        var status  = instances.length > 0 ? 'UP'.green : 'DOWN'.red;\n        var counter = system.scalable ? instances.length : '-';\n\n        var line   = [system.name, status, counter, hostname, ports.join(', ')];\n        this.table_push(table_status, line);\n      }\n\n      this.table_show(table_status);\n    });\n  }\n\n  _ports_map(system, instances) {\n    return async(this, function* () {\n      var instance, ports = [];\n\n      instances = _.clone(instances);\n      while(instance = instances.pop()) {\n        _.each(instance.NetworkSettings.Access, (port) => {\n          var name = system.portName(port.name);\n          ports.push(`${instance.Annotations.azk.seq}-${name}:${port.port || \"n/m\".red}`);\n        });\n      }\n\n      return _.isEmpty(ports) ? [\"-\"] : ports;\n    });\n  }\n\n  reload(manifest, systems, opts) {\n    throw new NotBeenImplementedError('reload');\n  }\n}\n\nexport function init(cli) {\n  (new Cmd('start [system]', cli));\n  (new Cmd('stop [system]', cli));\n  (new Cmd('scale [system] [to]', cli));\n  (new Cmd('status [system]', cli));\n\n  (new Cmd('reload [system]', cli));\n}\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","var $__placeholder__0 = $__placeholder__1","$traceurRuntime.defaultSuperCall(this,\n                $__placeholder__0.prototype, arguments)","var $__placeholder__0 = $__placeholder__1","($traceurRuntime.createClass)($__placeholder__0, $__placeholder__1, $__placeholder__2,\n                                       $__placeholder__3)","return $__placeholder__0(\n            $__placeholder__1,\n            this);","$traceurRuntime.generatorWrap","function($ctx) {\n      while (true) $__placeholder__0\n    }","return $__placeholder__0","$ctx.maybeThrow()","$ctx.state = ($__placeholder__0) ? $__placeholder__1 : $__placeholder__2;\n        break","return $ctx.end()","$traceurRuntime.spread($__placeholder__0)","$ctx.sent","$ctx.returnValue = $__placeholder__0","\n        for (var $__placeholder__0 =\n                 $__placeholder__1[Symbol.iterator](),\n                 $__placeholder__2;\n             !($__placeholder__3 = $__placeholder__4.next()).done; ) {\n          $__placeholder__5;\n          $__placeholder__6;\n        }","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}