{"version":3,"file":"start.js","sources":["../../../src/cmds/start.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/21","@traceur/generated/TemplateParser/24","@traceur/generated/TemplateParser/23","@traceur/generated/TemplateParser/22","@traceur/generated/TemplateParser/15","@traceur/generated/TemplateParser/8","@traceur/generated/TemplateParser/14","@traceur/generated/TemplateParser/12","@traceur/generated/TemplateParser/10","@traceur/generated/TemplateParser/18","@traceur/generated/TemplateParser/13","@traceur/generated/TemplateParser/6","@traceur/generated/TemplateParser/11","@traceur/generated/TemplateParser/9","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"AAAA;ACAI,CAAJ,EAAI,CAAA,YAAY,mBAAoB,CAAC;UCArC,CAAA,OAAO,CFA6B,KAAK,CEAf;;;;;UAA1B,CAAA,OAAO,CFC0B,iBAAiB,CEDxB;;;cAA1B,CAAA,OAAO,CFEkB,cAAc,CEFb;UAA1B,CAAA,OAAO,CFGqD,kBAAkB,CEHpD;;;ACAtB,CAAJ,EAAI,MHKJ,SAAM,IAAG;AILT,CAAA,gBAAe,iBAAiB,CAAC,IAAI,CACrB,eAA2B,CAAE,UAAS,CAAC,CAAA;CDDd,AHgHxC,CGhHwC;AEArC,CAAJ,EAAI,WAAqC,CAAA;ACAzC,CAAA,AAAC,eAAe,YAAY,CAAC;CNM3B,OAAM,CAAN,UAAO,IAAI;CACT,SAAO,CAAA,KAAK,CAAC,IAAI,WAAa;;;;COPlC,WAAO,CCAP,eAAe,cDAS,ACAK,CCA7B,SAAS,IAAI,CAAE;CACT,cAAO,IAAI;;;;CCDjB,mBVQY,CAAA,OAAO,aAAa,EAAE,CURV;;ACAxB,CAAA,iBAAI,WAAW,EAAE,CAAA;;;;wBXUI,IAAI,SAAQ,CAAC,IAAI,IAAI,CAAE,KAAI,CAAC;uBAC5B,EAAC,QAAQ,cAAc,CAAC;CAEvC,iBAAI,IAAI,OAAO,CAAE;CACf,mBAAI,IAAI,OAAO,GAAI,OAAM,CAAE;AACzB,CAAA,wBAAO,EAAG,CAAA,CAAC,IAAI,CAAC,QAAQ,QAAQ,YAAG,MAAM,CAAK;CAC5C,yBAAO,OAAM,CAAC;mBACf,EAAC,CAAC;iBACJ,KAAM;gCACc,CAAA,IAAI,OAAO,MAAM,CAAC,GAAG,CAAC;AACzC,CAAA,wBAAO,EAAG,CAAA,CAAC,OAAO,CAAC,YAAY,YAAG,OAAO,CAAE,CAAA,IAAI,CAAK;AAClD,CAAA,0BAAO,KAAK,CAAC,QAAQ,OAAO,CAAC,IAAI,CAAE,KAAI,CAAC,CAAC,CAAC;CAC1C,yBAAO,QAAO,CAAC;mBAChB,EAAE,GAAE,CAAC,CAAC;iBACR;CAAA,cACF;CAAA;;;AYzBP,CAAA,iBAAI,YAAY,EZ2BH,CAAA,IAAI,EAAC,EAAG,EAAA,CAAA,IAAI,KAAK,EAAG,CAAC,QAAQ,CAAE,QAAO,CAAE,KAAI,CY3BrB,AZ2BsB,CY3BtB;;;;CCApC,mBAAO,CAAA,IAAI,IAAI,EAAE,CAAA;;CJCmB,MAC/B,CFAO,KAAI,CAAC,CAAC;MP0BZ,CAAC;GACJ;CAED,OAAM,CAAN,UAAO,MAAM,CAAE,CAAA,SAAS;;AAClB,CAAJ,MAAI,CAAA,QAAQ,aAAI,KAAK,CAAK;AACpB,CAAJ,QAAI,CAAA,aAAa,EAAG,CAAA,OAAO,gBAAgB,MAAM,CAAC;CAClD,SAAI,KAAK,KAAK,GAAI,WAAU,CAAE;AAC5B,CAAA,oBAAa,CAAC,KAAK,CAAC,CAAC;OACtB,KAAM;AACL,CAAA,cAAO,IAAI,CAAC,KAAK,CAAC,CAAC;OACpB;CAAA,IACF,CAAA,CAAA;CACD,SAAO,CAAA,MAAM,UAAU,CAAC,CAAE,IAAI,CAAE,KAAI,CAAE,CAAC,KAAK,YAAO;CACjD,WAAO,CAAA,MAAM,MAAM,CAAC,SAAS,CAAE,CAAA,WAAW,EAAE,CAAE,KAAI,CAAC,CAAC;KACrD,EAAC,SAAS,CAAC,QAAQ,CAAC,CAAC;GACvB;CAED,MAAK,CAAL,UAAM,QAAQ,CAAE,CAAA,OAAO;CACrB,SAAO,CAAA,KAAK,CAAC,IAAI,WAAa;;;;;CO9ClC,WAAO,CCAP,eAAe,cDAS,ACAK,CCA7B,SAAS,IAAI,CAAE;CACT,cAAO,IAAI;;;oBKCA,Cd6CQ,OAAO,Cc7CG,MAAM,SAAS,CAAC,EAAE;;;;ACFrD,CAAA,iBAAI,MAAM,EAAG,CAAA,CDIA,CAAC,CAAC,MAAoB,CAAA,SAAsB,EAAE,CAAC,KAAK,CCJjC,UAAwC,CAAC;CACjE,mBAAK;;;;;;;CLDb,mBVgD+B,CAAA,MAAM,UAAU,EAAE,CUhDzB;;0BMAxB,CAAA,IAAI,KAAK;;;;ADAT,CAAA,iBAAI,MAAM,EAAG,CAAA,CfiDD,UAAU,OAAO,EAAG,EAAC,CejDD,QAAwC,CAAC;CACjE,mBAAK;;AfiDH,CAAA,iBAAI,KAAK,CAAC,wBAAwB,CAAE,OAAM,CAAC,CAAC;;;;AYlDtD,CAAA,iBAAI,YAAY,EZmDC,mBYnDmB,AZmDD,CYnDC;;;;;CFApC,mBVqDc,CAAA,IAAI,OAAO,CAAC,MAAM,CAAE,EAAC,CAAC,CUrDZ;;ACAxB,CAAA,iBAAI,WAAW,EAAE,CAAA;;;;CEAjB,mBAAO,CAAA,IAAI,IAAI,EAAE,CAAA;;CJCmB,MAC/B,CFAO,KAAI,CAAC,CAAC;MPqDZ,CAAC;GACJ;CAED,MAAK,CAAL,UAAM,QAAQ,CAAE,CAAA,OAAO,CAAE,CAAA,IAAI;CAC3B,SAAO,CAAA,KAAK,CAAC,IAAI,WAAa;;;;CO3DlC,WAAO,CCAP,eAAe,cDAS,ACAK,CCA7B,SAAS,IAAI,CAAE;CACT,cAAO,IAAI;;;oBKCA,Cd0DQ,OAAO,Cc1DG,MAAM,SAAS,CAAC,EAAE;;;;ACFrD,CAAA,iBAAI,MAAM,EAAG,CAAA,CDIA,CAAC,CAAC,MAAoB,CAAA,SAAsB,EAAE,CAAC,KAAK,CCJjC,SAAwC,CAAC;CACjE,mBAAK;;;;;;;CLDb,mBV6Dc,CAAA,IAAI,OAAO,CAAC,MAAM,CAAE,CAAA,IAAI,UAAU,CAAC,CU7DzB;;ACAxB,CAAA,iBAAI,WAAW,EAAE,CAAA;;;;CEAjB,mBAAO,CAAA,IAAI,IAAI,EAAE,CAAA;;CJCmB,MAC/B,CFAO,KAAI,CAAC,CAAC;MP6DZ,CAAC;GACJ;CAED,KAAI,CAAJ,UAAK,QAAQ,CAAE,CAAA,OAAO,CAAE,CAAA,IAAI;CAC1B,SAAO,CAAA,KAAK,CAAC,IAAI,WAAa;;;;;COnElC,WAAO,CCAP,eAAe,cDAS,ACAK,CCA7B,SAAS,IAAI,CAAE;CACT,cAAO,IAAI;;;oBKCA,CdkEQ,OAAO,CclEG,MAAM,SAAS,CAAC,EAAE;;;;ACFrD,CAAA,iBAAI,MAAM,EAAG,CAAA,CDIA,CAAC,CAAC,MAAoB,CAAA,SAAsB,EAAE,CAAC,KAAK,CCJjC,UAAwC,CAAC;CACjE,mBAAK;;;;;;;CLDb,mBVqE+B,CAAA,MAAM,UAAU,EAAE,CUrEzB;;0BMAxB,CAAA,IAAI,KAAK;;;;ADAT,CAAA,iBAAI,MAAM,EAAG,CAAA,CfsED,UAAU,OAAO,GAAI,EAAC,CetEF,QAAwC,CAAC;CACjE,mBAAK;;AfsEH,CAAA,iBAAI,KAAK,CAAC,4BAA4B,CAAE,OAAM,CAAC,CAAC;;;;;CUvE1D,mBVyEgB,CAAA,IAAI,OAAO,CAAC,MAAM,CAAE,EAAC,CAAC,CUzEd;;ACAxB,CAAA,iBAAI,WAAW,EAAE,CAAA;;;;CEAjB,mBAAO,CAAA,IAAI,IAAI,EAAE,CAAA;;CJCmB,MAC/B,CFAO,KAAI,CAAC,CAAC;MP0EZ,CAAC;GACJ;CAED,OAAM,CAAN,UAAO,MAAM,CAAE,CAAA,SAAS,CAAE;CACxB,OAAI,SAAS,OAAO,GAAI,EAAC,CAAE;AACrB,CAAJ,QAAI,CAAA,KAAK,EAAG,CAAA,MAAM,MAAM,CAAC;CACzB,SAAI,KAAK,OAAO,GAAI,EAAC,CAAE;AACjB,CAAJ,UAAI,CAAA,QAAQ,EAAG,CAAA,SAAS,CAAC,CAAC,CAAC,CAAC;AAC5B,CAAA,YAAK,EAAG,EAAC,YAAY,EAAG,CAAA,QAAQ,MAAM,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC;OACvD;AACD,CADC,WACM,CAAA,KAAK,KAAK,CAAC,IAAI,CAAC,CAAC;KACzB;AACD,CADC,SACM,GAAE,CAAC;GACX;CAED,OAAM,CAAN,UAAO,QAAQ,CAAE,CAAA,OAAO,CAAE,CAAA,IAAI;CAC5B,SAAO,CAAA,KAAK,CAAC,IAAI,WAAa;;;;;CO5FlC,WAAO,CCAP,eAAe,cDAS,ACAK,CCA7B,SAAS,IAAI,CAAE;CACT,cAAO,IAAI;;;AT4FX,CAAA,iBAAI,OAAO,CAAC,kBAAkB,CAAC,CAAA;;;;oBc3FpB,Cd4FQ,OAAO,Cc5FG,MAAM,SAAS,CAAC,EAAE;;;;ACFrD,CAAA,iBAAI,MAAM,EAAG,CAAA,CDIA,CAAC,CAAC,MAAoB,CAAA,SAAsB,EAAE,CAAC,KAAK,CCJjC,SAAwC,CAAC;CACjE,mBAAK;;;;;;;CLDb,mBV+F8B,CAAA,MAAM,UAAU,CAAC,IAAI,IAAI,CAAC,CU/FhC;;yBMAxB,CAAA,IAAI,KAAK;;;;AhBgGD,CAAA,iBAAI,QAAQ,CAAC,wBAAwB,CAAE;AACrC,CAAA,qBAAM,CAAE,CAAA,MAAM,KAAK;AACnB,CAAA,wBAAS,CAAE,CAAA,SAAS,OAAO;AAC3B,CAAA,oBAAK,CAAE,CAAA,IAAI,OAAO,CAAC,MAAM,CAAE,UAAS,CAAC;CAAA,cACtC,CAAC,CAAC;;;;CapGX,mBAAO,CAAA,IAAI,IAAI,EAAE,CAAA;;CJCmB,MAC/B,CFAO,KAAI,CAAC,CAAC;MPoGZ,CAAC;GACJ;CAED,OAAM,CAAN,UAAO,QAAQ,CAAE,CAAA,OAAO,CAAE,CAAA,IAAI,CAAE;CAC9B,QAAM,IAAI,wBAAuB,CAAC,QAAQ,CAAC,CAAC;GAC7C;CAED,GAAE,CAAF,UAAG,QAAQ,CAAE,CAAA,OAAO,CAAE,CAAA,IAAI,CAAE;CAC1B,QAAM,IAAI,wBAAuB,CAAC,IAAI,CAAC,CAAC;GACzC;CAAA,KA1Ge,QAAO,CMJgC;CNiHlD,OAAS,KAAI,CAAC,GAAG,CAAE;AACxB,CAAA,EAAC,GAAI,IAAG,CAAC,OAAO,CAAE,IAAG,CAAC,CAAC,UACX,CAAC,CAAC,UAAU,CAAE,KAAI,CAAC,CAAE,EAAE,IAAI,CAAE,OAAM,CAAE,CAAC,CAAC;AAGnD,CAAA,EAAC,GAAI,IAAG,CAAC,MAAM,CAAE,IAAG,CAAC,CAAC,UACV,CAAC,CAAC,UAAU,CAAE,KAAI,CAAC,CAAE,EAAE,IAAI,CAAE,OAAM,CAAE,CAAC,CAAC;AAEnD,CAAA,EAAC,GAAI,IAAG,CAAC,OAAO,CAAE,IAAG,CAAC,CAAC,UACX,CAAC,CAAC,UAAU,CAAE,KAAI,CAAC,CAAE,EAAE,IAAI,CAAE,OAAM,CAAE,CAAC,UACtC,CAAC,CAAC,aAAa,CAAE,KAAI,CAAC,CAAE;AAAE,CAAA,OAAI,CAAE,OAAM;AAAE,CAAA,UAAO,CAAE,EAAC;CAAA,EAAE,CAAC,CAAC;AAElE,CAAA,EAAC,GAAI,IAAG,CAAC,QAAQ,CAAE,IAAG,CAAC,CAAC,UACZ,CAAC,CAAC,UAAU,CAAE,KAAI,CAAC,CAAE;AAAE,CAAA,OAAI,CAAE,OAAM;AAAE,CAAA,UAAO,CAAE,OAAM;CAAA,EAAE,CAAC,UACvD,CAAC,CAAC,OAAO,CAAE,KAAI,CAAC,CAAE,EAAE,OAAO,CAAE,MAAK,CAAE,CAAC,CAAC;AAElD,CAAA,EAAC,GAAI,IAAG,CAAC,QAAQ,CAAE,IAAG,CAAC,CAAC,UACZ,CAAC,CAAC,UAAU,CAAE,KAAI,CAAC,CAAE,EAAE,IAAI,CAAE,OAAM,CAAE,CAAC,CAAC;AAEnD,CAAA,EAAC,GAAI,IAAG,CAAC,IAAI,CAAE,IAAG,CAAC,CAAC,CAAC;CACtB;AiBtID,CjBsIC,KiBtIK,QAAQ;CCAd,WAAwB;CAAE,eAAyB;GAAE;ACArD,CAAA,WAAU,CAAE,KAAI;CAAA,AFAkB,CAAC;CjBuInC","sourcesContent":["import { _, async, config, t } from 'azk';\nimport { Command, Helpers } from 'azk/cli/command';\nimport { Manifest } from 'azk/manifest';\nimport { SYSTEMS_CODE_ERROR, NotBeenImplementedError } from 'azk/utils/errors';\n\nclass Cmd extends Command {\n  action(opts) {\n    return async(this, function* () {\n      yield Helpers.requireAgent();\n\n      var manifest = new Manifest(this.cwd, true);\n      var systems  = [manifest.systemDefault];\n\n      if (opts.system) {\n        if (opts.system == \":all\") {\n          systems = _.map(manifest.systems, (system) => {\n            return system;\n          });\n        } else {\n          var systems_name = opts.system.split(',');\n          systems = _.reduce(systems_name, (systems, name) => {\n            systems.push(manifest.system(name, true));\n            return systems;\n          }, []);\n        }\n      }\n\n      return this[`${this.name}`](manifest, systems, opts);\n    });\n  }\n\n  _scale(system, instances) {\n    var progress = (event) => {\n      var pull_progress = Helpers.newPullProgress(this);\n      if (event.type == \"pull_msg\") {\n        pull_progress(event);\n      } else {\n        console.log(event);\n      }\n    }\n    return system.provision({ pull: true }).then(() => {\n      return system.scale(instances, this.stdout(), true);\n    }).progress(progress);\n  }\n\n  start(manifest, systems) {\n    return async(this, function* () {\n      for (var system of systems) {\n        var containers = yield system.instances();\n        if (containers.length > 0) {\n          this.fail('commands.start.already', system);\n          return SYSTEMS_CODE_ERROR;\n        }\n        yield this._scale(system, 1);\n      }\n    });\n  }\n\n  scale(manifest, systems, opts) {\n    return async(this, function* () {\n      for (var system of systems) {\n        yield this._scale(system, opts.instances);\n      }\n    });\n  }\n\n  stop(manifest, systems, opts) {\n    return async(this, function* () {\n      for (var system of systems) {\n        var containers = yield system.instances();\n        if (containers.length <= 0) {\n          this.fail('commands.start.not_running', system);\n        } else {\n          yield this._scale(system, 0);\n        }\n      }\n    });\n  }\n\n  _hosts(system, instances) {\n    if (instances.length >= 1) {\n      var hosts = system.hosts;\n      if (hosts.length == 0) {\n        var instance = instances[0];\n        hosts = ['azk-agent:' + instance.Ports[0].PublicPort];\n      }\n      return hosts.join(', ');\n    }\n    return \"\";\n  }\n\n  status(manifest, systems, opts) {\n    return async(this, function* () {\n      this.output(\"Systems status: \")\n      for (var system of systems) {\n        var instances = yield system.instances(opts.all);\n        this.tOutput(\"commands.status.status\", {\n          system: system.name,\n          instances: instances.length,\n          hosts: this._hosts(system, instances),\n        });\n      }\n    });\n  }\n\n  reload(manifest, systems, opts) {\n    throw new NotBeenImplementedError('reload');\n  }\n\n  up(manifest, systems, opts) {\n    throw new NotBeenImplementedError('up');\n  }\n}\n\nexport function init(cli) {\n  (new Cmd('start', cli))\n    .addOption(['--system', '-s'], { type: String });\n\n  // TODO: Add kill\n  (new Cmd('stop', cli))\n    .addOption(['--system', '-s'], { type: String });\n\n  (new Cmd('scale', cli))\n    .addOption(['--system', '-s'], { type: String })\n    .addOption(['--instances', '-n'], { type: Number, default: 1 });\n\n  (new Cmd('status', cli))\n    .addOption(['--system', '-s'], { type: String, default: \":all\" })\n    .addOption(['--all', '-a'], { default: false });\n\n  (new Cmd('reload', cli))\n    .addOption(['--system', '-s'], { type: String });\n\n  (new Cmd('up', cli));\n}\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","var $__placeholder__0 = $__placeholder__1","$traceurRuntime.defaultSuperCall(this,\n                $__placeholder__0.prototype, arguments)","var $__placeholder__0 = $__placeholder__1","($traceurRuntime.createClass)($__placeholder__0, $__placeholder__1, $__placeholder__2,\n                                       $__placeholder__3)","return $__placeholder__0(\n            $__placeholder__1,\n            this);","$traceurRuntime.generatorWrap","function($ctx) {\n      while (true) $__placeholder__0\n    }","return $__placeholder__0","$ctx.maybeThrow()","$ctx.returnValue = $__placeholder__0","return $ctx.end()","\n        for (var $__placeholder__0 =\n                 $__placeholder__1[Symbol.iterator](),\n                 $__placeholder__2;\n             !($__placeholder__3 = $__placeholder__4.next()).done; ) {\n          $__placeholder__5;\n          $__placeholder__6;\n        }","$ctx.state = ($__placeholder__0) ? $__placeholder__1 : $__placeholder__2;\n        break","$ctx.sent","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}