{"version":3,"file":"pull.js","sources":["../../../src/docker/pull.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"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","sourcesContent":["import { Q, _ } from 'azk';\nimport { XRegExp } from 'xregexp';\nimport { ProvisionNotFound, ProvisionPullError } from 'azk/utils/errors';\n\nvar msg_regex = {\n  pulling_another    : new XRegExp('Repository.*another'),\n  pulling_repository : new XRegExp('Pulling repository (?<repository>.*)'),\n  pulling_layers     : new XRegExp('Pulling dependent layers'),\n  pulling_metadata   : new XRegExp('Pulling metadata'),\n  pulling_fs_layer   : new XRegExp('Pulling fs layer'),\n  pulling_image      : new XRegExp(\n    'Pulling image \\((?<tag>.*)\\) from (?<repository>.*), endpoint: (?<endpoint>.*)'\n  ),\n  download: new XRegExp('Downloading'),\n  download_complete: new XRegExp('Download complete'),\n}\n\nfunction parse_status(msg) {\n  if (msg) {\n    var result = {};\n    if (_.any(msg_regex, (regex, type) => {\n      var match  = XRegExp.exec(msg, regex);\n      if (match) {\n        result['type'] = type;\n        _.each(regex.xregexp.captureNames, function(key) {\n          if (match[key]) {\n            result[key] = match[key];\n          }\n        });\n        return true;\n      }\n    })) return result;\n  }\n}\n\nexport function pull(docker, repository, tag, stdout) {\n  var done  = Q.defer();\n  var image = `${repository}:${tag}`;\n\n  docker.createImage({\n    fromImage: repository,\n    tag: tag,\n  }).then((stream) => {\n    stream.on('data', (data) => {\n      var msg  = JSON.parse(data.toString());\n      msg.type = \"pull_msg\";\n      if (msg.error) {\n        if (msg.error.match(/404/)) {\n          return done.reject(new ProvisionNotFound(image));\n        }\n        done.reject(new ProvisionPullError(image, msg.error));\n      } else {\n        msg.statusParsed = parse_status(msg.status);\n        if (msg.statusParsed) {\n          done.notify(msg);\n        }\n        if (stdout) {\n          stdout.write(msg.status + \"\\n\");\n        }\n      }\n    });\n\n    stream.on('end', () => done.resolve(image));\n  })\n  .fail(done.reject);\n\n  return done.promise;\n}\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}