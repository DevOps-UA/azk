{"version":3,"file":"run.js","sources":["../../../src/system/run.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/13","@traceur/generated/TemplateParser/6","@traceur/generated/TemplateParser/12","@traceur/generated/TemplateParser/8","@traceur/generated/TemplateParser/9","@traceur/generated/TemplateParser/10","@traceur/generated/TemplateParser/7","@traceur/generated/TemplateParser/11","@traceur/generated/TemplateParser/14","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"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","sourcesContent":["import { _, async, config} from 'azk';\nimport docker from 'azk/docker';\nimport { ImageNotAvailable, SystemRunError, RunCommandError } from 'azk/utils/errors';\nimport net from 'azk/utils/net';\nimport { Balancer } from 'azk/system/balancer';\n\nvar MemoryStream = require('memorystream');\n\nvar Run = {\n\n  runProvision(system, options = {}) {\n    return async(this, function* (notify) {\n      var steps = system.provision_steps;\n\n      options = _.defaults(options, {\n        provision_force: false,\n      });\n\n      if (_.isEmpty(steps)) return null;\n      if ((!options.provision_force) && system.provisioned) return null;\n\n      // provision command (require /bin/sh)\n      var cmd  = [\"/bin/sh\", \"-c\", \"( \" + steps.join('; ') + \" )\"];\n\n      // Capture outputs\n      var output = \"\";\n      options = _.clone(options);\n      options.shell_type = \"provision\";\n      options.stdout = new MemoryStream();\n      options.stdout.on('data', (data) => {\n        output += data.toString();\n      });\n\n      notify({ type: \"provision\", system: system.name });\n      var exitResult = yield system.runShell(cmd, options);\n      if (exitResult.code != 0) {\n        throw new RunCommandError(cmd.join(' '), output);\n      }\n      // save the date provisioning\n      system.provisioned = new Date();\n    });\n  },\n\n  runShell(system, command, options = {}) {\n    return async(this, function* () {\n      options = _.defaults(options, {\n        remove: false,\n        sequencies: yield this._getSequencies(system)\n      });\n\n      yield this._check_image(system, options);\n      var docker_opt = system.shellOptions(options);\n\n      var container  = yield docker.run(system.image.name, command, docker_opt);\n      var data       = yield container.inspect();\n\n      // Remove before run\n      if (options.remove) { yield container.remove(); }\n\n      return {\n        code: data.State.ExitCode,\n        containerId: container.Id,\n        removed: options.remove,\n      }\n    });\n  },\n\n  runDaemon(system, options = {}) {\n    return async(this, function* (notify) {\n      // TODO: add instances and dependencies options\n      // Prepare options\n      var image = yield this._check_image(system, options);\n      options.image_data = image;\n\n      // Check provision\n      yield system.runProvision(options);\n\n      options = _.defaults(options, {\n        sequencies: yield this._getSequencies(system),\n        wait: true,\n      });\n\n      var docker_opt = system.daemonOptions(options);\n      var command    = docker_opt.command;\n      var container  = yield docker.run(system.image.name, command, docker_opt);\n\n      if (options.wait) {\n        // TODO: support to wait udp protocol\n        var data = yield container.inspect();\n        var port_data = _.chain(data.NetworkSettings.Access)\n          .filter((port) => {\n            return port.protocol == 'tcp'\n          })\n          .find()\n          .value();\n\n        if (!_.isEmpty(port_data)) {\n          var retry   = options.timeout || config('docker:run:retry');\n          var timeout = options.retry   || config('docker:run:timeout');\n\n          yield this._wait_available(system, port_data, container, retry, timeout);\n        }\n\n        // Adding to balancer\n        yield Balancer.add(system, container);\n      }\n\n      return container;\n    });\n  },\n\n  stop(system, instances, options = {}) {\n    options = _.defaults(options, {\n      kill: false,\n      remove: true,\n    });\n\n    return async(function* (notify) {\n      var container = null;\n\n      // Default stop all\n      if (_.isEmpty(instances)) {\n        instances = yield system.instances();\n      }\n\n      while (container = instances.pop()) {\n        container = docker.getContainer(container.Id);\n\n        // Remove from balancer\n        yield Balancer.remove(system, container);\n\n        if (options.kill) {\n          notify({ type: 'kill_service', system: system.name });\n          yield container.kill();\n        } else {\n          notify({ type: 'stop_service', system: system.name });\n          yield container.stop();\n        }\n        notify({ type: \"stopped\", id: container.Id });\n        if (options.remove)\n          yield container.remove();\n      }\n\n      return true;\n    });\n  },\n\n  // Wait for container/system available\n  _wait_available(system, port_data, container, retry, timeout) {\n    return async(this, function* () {\n      if (config('agent:requires_vm')) {\n        var host = config('agent:vm:ip');\n      } else {\n        var host = port_data.gateway;\n      }\n\n      // Wait for available\n      var wait_opts = {\n        timeout: timeout,\n        retry_if: () => {\n          return container.inspect().then((data) => {\n            return data.State.Running;\n          });\n        },\n      };\n\n      var running = yield net.waitService(host, port_data.port, retry, wait_opts);\n\n      if (!running) {\n        var data = yield container.inspect();\n        var log  = yield container.logs({stdout: true, stderr: true});\n        yield this.stop(system, [container], { kill: true, remove: true });\n        throw new SystemRunError(\n          system.name,\n          container,\n          data.Config.Cmd.join(' '),\n          data.State.ExitCode,\n          log\n        );\n      }\n\n      return true;\n    });\n  },\n\n  // Check and pull image\n  _check_image(system, options) {\n    options = _.defaults(options, {\n      image_pull: true,\n    });\n\n    return async(function* () {\n      if (options.image_pull) {\n        var promise = system.image.pull();\n      } else {\n        var promise = system.image.check().then((image) => {\n          if (image == null) {\n            throw new ImageNotAvailable(system.name, system.image.name);\n          }\n          return image;\n        });\n      }\n\n      var image = yield promise.progress((event) => {\n        event.system = system;\n        return event;\n      });\n\n      return image.inspect();\n    });\n  },\n\n  _getSequencies(system, type = \"*\") {\n    return async(this, function*() {\n      var instances = yield system.instances({ type: type });\n\n      return _.reduce(instances, (sequencies, instance) => {\n        var type = instance.Annotations.azk.type;\n        var seq  = parseInt(instance.Annotations.azk.seq);\n        if (seq === sequencies[type]) {\n          sequencies[type] = sequencies[type] + 1;\n        }\n        return sequencies;\n      }, { shell: 1, daemon: 1 });\n    });\n  },\n\n  instances(system, options = {}) {\n    // Default options\n    options = _.defaults(options, {\n      include_dead: false,\n      include_exec: false,\n      type: \"*\",\n    });\n\n    // Include dead containers\n    var query_options = {};\n    if (options.include_dead) query_options.all = true ;\n\n    return docker.azkListContainers(query_options).then((containers) => {\n      var instances = _.filter(containers, (container) => {\n        var azk = container.Annotations.azk;\n        return (\n          azk.mid == system.manifest.namespace &&\n          azk.sys == system.name &&\n          ( options.type == \"*\" || azk.type == options.type )\n        )\n      });\n\n      return _.sortBy(instances, (instance) => { return instance.Annotations.azk.seq });\n    });\n  },\n}\n\nexport { Run }\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","return $__placeholder__0(\n            $__placeholder__1,\n            this);","$traceurRuntime.generatorWrap","function($ctx) {\n      while (true) $__placeholder__0\n    }","$ctx.state = ($__placeholder__0) ? $__placeholder__1 : $__placeholder__2;\n        break","$ctx.returnValue = $__placeholder__0","return $__placeholder__0","$ctx.sent","return $ctx.end()","$ctx.maybeThrow()","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}