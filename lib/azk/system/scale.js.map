{"version":3,"file":"scale.js","sources":["../../../src/system/scale.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/14","@traceur/generated/TemplateParser/6","@traceur/generated/TemplateParser/13","@traceur/generated/TemplateParser/9","@traceur/generated/TemplateParser/7","@traceur/generated/TemplateParser/10","@traceur/generated/TemplateParser/8","@traceur/generated/TemplateParser/11","@traceur/generated/TemplateParser/12","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"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","sourcesContent":["import { Q, async, _ } from 'azk';\nimport { SystemDependError, SystemNotScalable } from 'azk/utils/errors';\nimport docker from 'azk/docker';\n\nvar Scale = {\n  scale(system, instances, options = {}) {\n    // Protect not scalable systems\n    if (!system.scalable && instances > 1) {\n      return Q.reject(new SystemNotScalable(system));\n    }\n\n    // Default options\n    options = _.defaults(options, {\n      envs: {},\n    });\n\n    return async(this, function* (notify) {\n      var deps_envs = yield this.checkDependsAndReturnEnvs(system);\n      options.envs = _.merge(deps_envs, options.envs || {});\n\n      var containers = yield this.instances(system);\n\n      var from = containers.length;\n      var icc  = instances - from;\n\n      if (icc != 0)\n        notify({ type: \"scale\", from, to: from + icc, system: this.name });\n\n      if (icc > 0) {\n        for(var i = 0; i < icc; i++) {\n          yield system.runDaemon(options);\n        }\n      } else if (icc < 0) {\n        containers = containers.reverse().slice(0, Math.abs(icc));\n        yield this._kill_or_stop(containers);\n      }\n\n      return true;\n    });\n  },\n\n  killAll(system, options = {}) {\n    options = _.defaults(options, {\n      kill: true,\n    });\n\n    return this.instances(system).then((instances) => {\n      return system.stop(instances, options.kill);\n    });\n  },\n\n  checkDependsAndReturnEnvs(system) {\n    var depends = system.dependsInstances;\n    return async(this, function* () {\n      var instances, depend, envs = {};\n\n      for (var d = 0; d < depends.length; d++) {\n        depend    = depends[d];\n        instances = yield this.instances(depend);\n        if (_.isEmpty(instances)) {\n          throw new SystemDependError(system.name, depend.name);\n        }\n        envs = _.merge(envs, yield this.getEnvs(depend, instances));\n      }\n\n      return envs;\n    });\n  },\n\n  getEnvs(system, instances = null) {\n    return async(this, function* () {\n      var ports = {}, envs = {};\n      if (instances.length > 0) {\n        var data = yield docker.getContainer(instances[0].Id).inspect();\n        _.each(data.NetworkSettings.Access, (port) => {\n          ports[port.name] = port.port;\n        });\n        envs = system.expandExportEnvs({\n          envs: this._parseEnvs(data.Config.Env),\n          net: { port: ports }\n        });\n      }\n      return envs;\n    });\n  },\n\n  _parseEnvs(collection) {\n    return _.reduce(collection, (envs, env) => {\n      if (env.match(/\\=/)) {\n        env = env.split(\"=\");\n        envs[env[0]] = env[1];\n      }\n      return envs;\n    }, {});\n  },\n\n  instances(system, options = {}) {\n    // Default options\n    options = _.defaults(options, {\n      include_dead: false,\n      include_exec: false,\n    })\n\n    // Include dead containers\n    var query_options = {};\n    if (options.include_dead) query_options.all = true ;\n\n    return docker.azkListContainers(query_options).then((containers) => {\n      return _.filter(containers, (container) => {\n        var azk = container.Annotations.azk;\n        return azk.mid == system.manifest.namespace && azk.sys == system.name;\n      });\n    });\n  },\n}\n\nexport { Scale };\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","return $__placeholder__0(\n            $__placeholder__1,\n            this);","$traceurRuntime.generatorWrap","function($ctx) {\n      while (true) $__placeholder__0\n    }","return $__placeholder__0","$ctx.sent","$ctx.state = ($__placeholder__0) ? $__placeholder__1 : $__placeholder__2;\n        break","$ctx.maybeThrow()","$ctx.returnValue = $__placeholder__0","return $ctx.end()","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}