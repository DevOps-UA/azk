{"version":3,"file":"scale.js","sources":["../../../src/system/scale.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/18","@traceur/generated/TemplateParser/10","@traceur/generated/TemplateParser/17","@traceur/generated/TemplateParser/13","@traceur/generated/TemplateParser/11","@traceur/generated/TemplateParser/14","@traceur/generated/TemplateParser/12","@traceur/generated/TemplateParser/15","@traceur/generated/TemplateParser/16","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"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","sourcesContent":["import { Q, async, _ } from 'azk';\nimport { SystemDependError, SystemNotScalable } from 'azk/utils/errors';\nimport docker from 'azk/docker';\n\nvar Scale = {\n  start(system, options = {}) {\n    return this.scale(system, system.default_instances, options);\n  },\n\n  scale(system, instances, options = {}) {\n    // Protect not scalable systems\n    if (!system.scalable && instances > 1) {\n      return Q.reject(new SystemNotScalable(system));\n    }\n\n    // Default options\n    options = _.defaults(options, {\n      envs: {},\n    });\n\n    return async(this, function* (notify) {\n      var deps_envs = yield this.checkDependsAndReturnEnvs(system);\n      options.envs = _.merge(deps_envs, options.envs || {});\n\n      var containers = yield this.instances(system);\n\n      var from = containers.length;\n      var icc  = instances - from;\n\n      if (icc != 0)\n        notify({ type: \"scale\", from, to: from + icc, system: this.name });\n\n      if (icc > 0) {\n        for(var i = 0; i < icc; i++) {\n          yield system.runDaemon(options);\n        }\n      } else if (icc < 0) {\n        containers = containers.reverse().slice(0, Math.abs(icc));\n        yield system.stop(containers, { rm: true });\n      }\n\n      return icc;\n    });\n  },\n\n  killAll(system, options = {}) {\n    options = _.defaults(options, {\n      kill: true,\n    });\n\n    return this.instances(system).then((instances) => {\n      return system.stop(instances, options.kill);\n    });\n  },\n\n  checkDependsAndReturnEnvs(system) {\n    var depends = system.dependsInstances;\n    return async(this, function* () {\n      var instances, depend, envs = {};\n\n      for (var d = 0; d < depends.length; d++) {\n        depend    = depends[d];\n        instances = yield this.instances(depend);\n        if (_.isEmpty(instances)) {\n          throw new SystemDependError(system.name, depend.name);\n        }\n        envs = _.merge(envs, yield this.getEnvs(depend, instances));\n      }\n\n      return envs;\n    });\n  },\n\n  getEnvs(system, instances = null) {\n    return async(this, function* () {\n      var ports = {}, envs = {};\n      if (instances.length > 0) {\n        var data = yield docker.getContainer(instances[0].Id).inspect();\n        _.each(data.NetworkSettings.Access, (port) => {\n          ports[port.name] = port.port;\n        });\n        envs = system.expandExportEnvs({\n          envs: this._parseEnvs(data.Config.Env),\n          net: { port: ports }\n        });\n      }\n      return envs;\n    });\n  },\n\n  _parseEnvs(collection) {\n    return _.reduce(collection, (envs, env) => {\n      if (env.match(/\\=/)) {\n        env = env.split(\"=\");\n        envs[env[0]] = env[1];\n      }\n      return envs;\n    }, {});\n  },\n\n  instances(system, options = {}) {\n    // Default options\n    options = _.defaults(options, {\n      include_dead: false,\n      include_exec: false,\n    })\n\n    // Include dead containers\n    var query_options = {};\n    if (options.include_dead) query_options.all = true ;\n\n    return docker.azkListContainers(query_options).then((containers) => {\n      return _.filter(containers, (container) => {\n        var azk = container.Annotations.azk;\n        return azk.mid == system.manifest.namespace && azk.sys == system.name;\n      });\n    });\n  },\n}\n\nexport { Scale };\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","return $__placeholder__0(\n            $__placeholder__1,\n            this);","$traceurRuntime.generatorWrap","function($ctx) {\n      while (true) $__placeholder__0\n    }","return $__placeholder__0","$ctx.sent","$ctx.state = ($__placeholder__0) ? $__placeholder__1 : $__placeholder__2;\n        break","$ctx.maybeThrow()","$ctx.returnValue = $__placeholder__0","return $ctx.end()","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}