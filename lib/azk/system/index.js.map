{"version":3,"file":"index.js","sources":["../../../src/system/index.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/6","@traceur/generated/TemplateParser/7","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"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","sourcesContent":["import { _, t, config, path } from 'azk';\nimport { Image } from 'azk/images';\nimport { net } from 'azk/utils';\n\nexport class System {\n  constructor(manifest, name, image, options = {}) {\n    this.manifest = manifest;\n    this.name     = name;\n    this.image    = new Image(image);\n    this.options  = _.merge({}, this.default_options, options);\n    this.options  = this._expand_template(this.options);\n  }\n\n  get default_options() {\n    var msg = t(\"system.cmd_not_set\", {system: this.name});\n    return {\n      command : `echo \"${msg}\"; exit 1`,\n      shell   : \"/bin/sh\",\n      depends : [],\n      workdir : \"/\",\n      envs    : {},\n    }\n  }\n\n  // Get options\n  get command()           { return this.options.command };\n  get workdir()           { return this.options.workdir };\n  get shell()             { return this.options.shell };\n  get raw_mount_folders() { return this.options.mount_folders };\n  get namespace() {\n    return this.manifest.namespace + '-sys.' + this.name;\n  }\n\n  // Envs\n  get envs() { return this.options.envs; }\n\n  // Volumes options\n  get volumes() {\n    var volumes = { };\n\n    // Volumes\n    _.each(this.raw_mount_folders, (target, point) => {\n      point = path.resolve(this.manifest.manifestPath, point);\n      volumes[point] = target;\n    });\n\n    return volumes;\n  }\n\n  // Get depends info\n  get depends() { return this.options.depends };\n  get dependsInstances() {\n    return _.map(this.depends, (depend) => {\n      return this.manifest.system(depend, true);\n    });\n  };\n\n  // Docker run options\n  daemonOptions(options = {}) {\n    return this._make_options(true, options);\n  }\n\n  shellOptions(options = {}) {\n    return this._make_options(false, options);\n  }\n\n  _make_options(daemon, options = {}) {\n    // Default values\n    options = _.defaults(options, {\n      workdir: this.options.workdir,\n      volumes: {},\n      evns: {},\n    });\n\n    //var name = this.namespace + (daemon ? 'type.daemon' : 'type.exec');\n    var run_options = {\n      daemon: daemon,\n      ports: {},\n      volumes: _.merge({}, this.volumes, options.volumes),\n      working_dir: options.workdir || this.workdir,\n      env: _.merge({}, this.envs, options.envs),\n      dns: net.nameServers(),\n    }\n\n    // Daemon or exec mode?\n    //if (!daemon) {\n      //name += opts.interactive ? '.interactive' : '.raw';\n      //_.merge(run_options, {\n        //tty: opts.interactive ? opts.stdout.isTTY : false,\n        //stdout: opts.stdout,\n        //stderr: opts.stderr || opts.stdout,\n        //stdin: opts.interactive ? (opts.stdin) : null,\n      //});\n    //}\n\n    // Persistent dir\n    //run_options.local_volumes = _.merge(\n      //{}, run_options.local_volumes, this.persistent_folders\n    //);\n\n    //run_options.ns = name;\n    return run_options;\n  }\n\n  _expand_template(options) {\n    var data = {\n      system: {\n        name: this.name,\n        persistent_folders: \"/data\",\n      },\n      manifest: {\n        dir: this.manifest.manifestDirName,\n        project_name: this.manifest.manifestDirName,\n      },\n      azk: {\n        default_domain: config('agent:balancer:host'),\n        balancer_port: config('agent:balancer:port'),\n        balancer_ip: config('agent:balancer:ip'),\n      }\n    };\n    return JSON.parse(_.template(JSON.stringify(options), data));\n  }\n}\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","var $__placeholder__0 = $__placeholder__1","($traceurRuntime.createClass)($__placeholder__0, $__placeholder__1, $__placeholder__2)","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}