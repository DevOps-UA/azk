{"version":3,"file":"balancer.js","sources":["../../../src/system/balancer.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/11","@traceur/generated/TemplateParser/6","@traceur/generated/TemplateParser/10","@traceur/generated/TemplateParser/7","@traceur/generated/TemplateParser/8","@traceur/generated/TemplateParser/9","@traceur/generated/TemplateParser/13","@traceur/generated/TemplateParser/12","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"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","sourcesContent":["import { async, config } from 'azk';\n\nvar SystemBalancer = {\n  get balancer() {\n    return require('azk/agent/balancer').Balancer;\n  },\n\n  clear(system) {\n    return async(this, function*() {\n      if (system.balanceable) {\n        return this.balancer.removeAll(system.hostname);\n      }\n      return false;\n    });\n  },\n\n  add(system, container) {\n    return this._addOrRemove(system, container, 'addBackend');\n  },\n\n  remove(system, container) {\n    return this._addOrRemove(system, container, 'removeBackend');\n  },\n\n  list(system) {\n    if (system.balanceable) {\n      return this.balancer.getBackends(system.hostname);\n    } else {\n      return Q([]);\n    }\n  },\n\n  _addOrRemove(system, container, method) {\n    return async(this, function* () {\n      if (system.balanceable) {\n        var data = yield container.inspect();\n        if (data.State.Running) {\n          var backend = this._formatBackend(system, data);\n          if (backend) {\n            return this.balancer[method](system.hosts, backend);\n          }\n        }\n      }\n\n      return null;\n    });\n  },\n\n  _formatBackend(system, container) {\n    var port = container.NetworkSettings.Access[system.http_port] || {};\n    if (port.port) {\n      return `http://${config('agent:vm:ip')}:${port.port}`;\n    }\n  },\n}\n\nexport { SystemBalancer }\nexport { SystemBalancer as Balancer }\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","return $__placeholder__0(\n            $__placeholder__1,\n            this);","$traceurRuntime.generatorWrap","function($ctx) {\n      while (true) $__placeholder__0\n    }","$ctx.state = ($__placeholder__0) ? $__placeholder__1 : $__placeholder__2;\n        break","$ctx.returnValue = $__placeholder__0","return $ctx.end()","return $__placeholder__0","$ctx.sent","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}