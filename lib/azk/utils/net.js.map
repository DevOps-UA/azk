{"version":3,"file":"net.js","sources":["../../../src/utils/net.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/26","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"AAAA;ACAI,CAAJ,EAAI,CAAA,YAAY,kBAAoB,CAAC;UCArC,CAAA,OAAO,CFA6B,KAAK,CEAf;;;;;AFEtB,CAAJ,EAAI,CAAA,SAAS,EAAG,CAAA,OAAO,CAAC,KAAK,CAAC,CAAC;AAC3B,CAAJ,EAAI,CAAA,GAAG,EAAS,CAAA,OAAO,CAAC,KAAK,CAAC,CAAC;AAC3B,CAAJ,EAAI,CAAA,SAAS,EAAG,CAAA,MAAM,CAAC,uBAAuB,CAAC,CAAC;AAE5C,CAAJ,EAAI,CAAA,GAAG,EAAG;CACR,QAAO,CAAP,UAAQ;;AACF,CAAJ,MAAI,CAAA,IAAI,EAAK,UAAS,CAAC;AACvB,CAAA,YAAS,GAAI,EAAC,CAAC;AACX,CAAJ,MAAI,CAAA,MAAM,EAAG,CAAA,SAAS,aAAa,EAAE,CAAC;CAEtC,SAAO,CAAA,KAAK,WAAE,IAAI;AAChB,CAAA,WAAM,OAAO,CAAC,IAAI,YAAG,GAAG;AACtB,CAAA,aAAM,KAAK,CAAC,OAAO,aAAQ;AACzB,CAAA,aAAI,QAAQ,CAAC,IAAI,CAAC,CAAC;SACpB,EAAC,CAAC;AACH,CAAA,aAAM,MAAM,EAAE,CAAC;SACf,CAAC;AACH,CAAA,WAAM,GAAG,CAAC,OAAO,YAAG,GAAG,CAAK;AAC1B,CAAA,WAAI,QAAQ,CAAC,YAAY,EAAE,CAAC,CAAC;OAC9B,EAAC,CAAC;OACH,CAAC;GACJ;CAED,eAAc,CAAd,UAAe,EAAE,CAAE;CACjB,SAAO,CAAA,EAAE,QAAQ,CAAC,YAAY,CAAE,UAAS,CAAC,CAAC;GAC5C;CAED,mBAAkB,CAAlB,UAAmB,EAAE,CAAE;CACrB,SAAO,CAAA,EAAE,QAAQ,CAAC,YAAY,CAAE,OAAM,CAAC,CAAC;GACzC;CAED,YAAW,CAAX,UAAY,IAAI,CAAE,CAAA,IAAI,AAAuB;OAArB,MAAK,6CAAG,GAAE;OAAE,KAAI,6CAAG,GAAE;AAC3C,CAAA,OAAI,EAAG,CAAA,CAAC,MAAM,CAAC,CAAE,OAAO,CAAE,MAAK,CAAE,CAAE,KAAI,CAAC,CAAC;CAEzC,SAAO,CAAA,KAAK,WAAE,OAAO,CAAE,CAAA,MAAM,CAAE,CAAA,MAAM;AAC/B,CAAJ,QAAI,CAAA,MAAM,EAAK,KAAI,CAAC;AAChB,CAAJ,QAAI,CAAA,QAAQ,EAAG,EAAC;AAAE,CAAA,YAAG,EAAG,MAAK,CAAC;AAC1B,CAAJ,QAAI,CAAA,OAAO;AACT,CAAA,aAAM,CAAC;AAAE,CAAA,aAAI,CAAE,cAAa;AAAE,CAAA,iBAAQ,CAAR,SAAQ;AAAE,CAAA,YAAG,CAAH,IAAG;AAAE,CAAA,gBAAO,CAAE,CAAA,IAAI,QAAQ;CAAA,QAAE,CAAC,CAAC;AAClE,CAAJ,UAAI,CAAA,CAAC,EAAG,KAAI,CAAC;AAEb,CAAA,aAAM,EAAG,CAAA,SAAS,QAAQ,CAAC;AAAE,CAAA,aAAI,CAAJ,KAAI;AAAE,CAAA,aAAI,CAAJ,KAAI;CAAA,QAAC,CAAE,UAAS,CAAE;AACnD,CAAA,eAAM,IAAI,EAAE,CAAC;AACb,CAAA,qBAAY,CAAC,CAAC,CAAC,CAAC;AAChB,CAAA,gBAAO,CAAC,IAAI,CAAC,CAAC;SACf,CAAC,CAAC;AAEH,CAAA,QAAC,EAAG,CAAA,UAAU,YAAO;AACnB,CAAA,eAAM,IAAI,EAAE,CAAC;CACb,aAAI,QAAQ,EAAG,IAAG;CAAE,iBAAO,CAAA,OAAO,CAAC,KAAK,CAAC,CAAC;AAE1C,CAF0C,iBAElC,GAAI,EAAC,CAAC;AACd,CAAA,gBAAO,EAAE,CAAC;SACX,EAAE,CAAA,IAAI,QAAQ,CAAC,CAAC;AAEjB,CAAA,aAAM,GAAG,CAAC,OAAO,YAAG,KAAK,CAAK,GAK7B,EAAC,CAAC;QACJ,CAAA;AACD,CAAA,YAAO,EAAE,CAAC;OACV,CAAC;GACJ;CAGD,sBAAqB,CAArB,UAAsB,IAAI,CAAE,CAAA,IAAI,AAA6B;OAA3B,MAAK,6CAAG,GAAE;OAAE,QAAO,6CAAG,MAAK;CAC3D,SAAO,CAAA,KAAK,WAAE,OAAO,CAAE,CAAA,MAAM,CAAE,CAAA,MAAM;AAC/B,CAAJ,QAAI,CAAA,MAAM,EAAK,KAAI,CAAC;AAChB,CAAJ,QAAI,CAAA,QAAQ,EAAG,EAAC;AAAE,CAAA,YAAG,EAAG,MAAK,CAAC;AAC1B,CAAJ,QAAI,CAAA,OAAO;AACT,CAAA,aAAM,CAAC;AAAE,CAAA,aAAI,CAAE,cAAa;AAAE,CAAA,iBAAQ,CAAR,SAAQ;AAAE,CAAA,YAAG,CAAH,IAAG;CAAA,QAAE,CAAC,CAAC;AAE3C,CAAJ,UAAI,CAAA,YAAY,EAAG,UAAS,CAAE;AAC5B,CAAA,iBAAQ,GAAI,EAAC,CAAC;AACd,CAAA,gBAAO,EAAE,CAAC;SACX,CAAA;AAED,CAAA,aAAM,EAAG,CAAA,SAAS,QAAQ,CAAC;AAAE,CAAA,aAAI,CAAJ,KAAI;AAAE,CAAA,aAAI,CAAJ,KAAI;CAAA,QAAC,CAAE,UAAS,CAAE;AACnD,CAAA,eAAM,GAAG,CAAC,MAAM,CAAE,UAAS,IAAI,CAAE;AAC/B,CAAA,iBAAM,QAAQ,EAAE,CAAC;AACjB,CAAA,kBAAO,EAAE,CAAC;WACX,CAAC,CAAC;CACH,aAAI,QAAQ,GAAI,IAAG,CAAE;AACnB,CAAA,iBAAM,WAAW,CAAC,OAAO,CAAE,aAAY,CAAC,CAAC;WAC1C,KAAM;AACL,CAAA,iBAAM,QAAQ,EAAE,CAAC;AACjB,CAAA,iBAAM,EAAE,CAAC;WACV;CAAA,QACF,CAAC,CAAC;AAEH,CAAA,aAAM,GAAG,CAAC,OAAO,YAAG,KAAK,CAAK;CAC5B,aAAG,KAAK,KAAK,GAAI,eAAc,CAAA,EAAI,CAAA,QAAQ,GAAI,IAAG,CAAE;AAClD,CAAA,qBAAU,CAAC,YAAY,CAAE,QAAO,CAAC,CAAC;WACnC,KAAM;AACL,CAAA,iBAAM,CAAC,KAAK,CAAC,CAAA;WACd;CAAA,QACF,EAAC,CAAC;QACJ,CAAA;AAED,CAAA,YAAO,EAAE,CAAC;OACV,CAAC;GACJ;CACF,CAAA;AG1GG,CAAJ,EAAI,CAAA,UAAU,EH4GC,IG5GmB,AH4GhB,CG5GgB;ACAlC,CAAA,KAAM,QAAQ;CCAd,cAAwB;CAAE,qBAAyB;GAAE;ACArD,CAAA,WAAU,CAAE,KAAI;CAAA,AFAkB,CAAC;CJ6GnC","sourcesContent":["import { Q, _, defer, config } from 'azk';\n\nvar nativeNet = require('net');\nvar dns       = require('dns');\nvar portrange = config(\"agent:portrange_start\");\n\nvar net = {\n  getPort() {\n    var port   = portrange;\n    portrange += 1;\n    var server = nativeNet.createServer();\n\n    return defer((done) => {\n      server.listen(port, (err) => {\n        server.once('close', () => {\n          done.resolve(port);\n        });\n        server.close();\n      });\n      server.on('error', (err) => {\n        done.resolve(this.getPort());\n      });\n    });\n  },\n\n  calculateNetIp(ip) {\n    return ip.replace(/^(.*)\\..*$/, \"$1.0/24\");\n  },\n\n  calculateGatewayIp(ip) {\n    return ip.replace(/^(.*)\\..*$/, \"$1.1\");\n  },\n\n  waitService(host, port, retry = 15, opts = {}) {\n    opts = _.merge({ timeout: 10000 }, opts);\n\n    return defer((resolve, reject, notify) => {\n      var client   = null;\n      var attempts = 1, max = retry;\n      var connect  = () => {\n        notify({ type: 'try_connect', attempts, max, context: opts.context });\n        var t = null;\n\n        client = nativeNet.connect({ host, port}, function() {\n          client.end();\n          clearTimeout(t);\n          resolve(true);\n        });\n\n        t = setTimeout(() => {\n          client.end();\n          if (attempts > max) return resolve(false);\n\n          attempts += 1;\n          connect();\n        }, opts.timeout);\n\n        client.on('error', (error) => {\n          //if(error.code != 'ECONNREFUSED') {\n            //clearTimeout(t);\n            //reject(error)\n          //}\n        });\n      }\n      connect();\n    });\n  },\n\n  // TODO: change for a generic service wait function\n  waitForwardingService(host, port, retry = 15, timeout = 10000) {\n    return defer((resolve, reject, notify) => {\n      var client   = null;\n      var attempts = 1, max = retry;\n      var connect  = () => {\n        notify({ type: 'try_connect', attempts, max });\n\n        var timeout_func = function() {\n          attempts += 1;\n          connect();\n        }\n\n        client = nativeNet.connect({ host, port}, function() {\n          client.on('data', function(data) {\n            client.destroy();\n            resolve();\n          });\n          if (attempts <= max) {\n            client.setTimeout(timeout, timeout_func);\n          } else {\n            client.destroy();\n            reject();\n          }\n        });\n\n        client.on('error', (error) => {\n          if(error.code == 'ECONNREFUSED' && attempts <= max) {\n            setTimeout(timeout_func, timeout);\n          } else {\n            reject(error)\n          }\n        });\n      }\n\n      connect();\n    });\n  },\n}\n\nexport default net;\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","var $__default = $__placeholder__0","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}